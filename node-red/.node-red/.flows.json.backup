[{"id":"89ad9af9.5b24b8","type":"tab","label":"Global setup","disabled":false,"info":"Function to set up global variables such as ip of local machine\n\n"},{"id":"84041e35.dbf49","type":"tab","label":"Get Devices and Data","disabled":false,"info":""},{"id":"f088168c.08c968","type":"tab","label":"Put data to Thingsboard","disabled":false,"info":""},{"id":"141904da.18313b","type":"tab","label":"DECLASSIFICATION: Compute cars per zone","disabled":false,"info":""},{"id":"9c1e076.5f7d4f8","type":"tab","label":"Fetch Taxi WebThings","disabled":false,"info":""},{"id":"a36580c0.b9cfc","type":"tab","label":"Taxi API","disabled":false,"info":""},{"id":"8f5695d4.26e138","type":"tab","label":"Fetch Hospital WebThings","disabled":false,"info":""},{"id":"e7ae0c3a.b2112","type":"tab","label":"API","disabled":false,"info":""},{"id":"d111d806.aa47b8","type":"tab","label":"Hospital Declassification","disabled":false,"info":""},{"id":"84e53390.36c6","type":"subflow","name":"Query device properties","info":"","category":"","in":[{"x":120,"y":80,"wires":[{"id":"a0873417.295ca8"}]}],"out":[{"x":760,"y":80,"wires":[{"id":"93965560.364828","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"1a50fa2e.f03ac6","type":"subflow","name":"Fetch web thing","info":"","category":"","in":[{"x":100,"y":200,"wires":[{"id":"57e4d8fb.08ec18"}]}],"out":[{"x":860,"y":140,"wires":[{"id":"11f7af50.4e17e1","port":0}]},{"x":860,"y":220,"wires":[{"id":"539ab21e.2baa5c","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"988498cc.3d0758","type":"subflow","name":"Fetch wot property","info":"","category":"","in":[{"x":140,"y":180,"wires":[{"id":"9285c4dc.af9268"}]}],"out":[{"x":1100,"y":180,"wires":[{"id":"2391851e.77056a","port":0}]},{"x":840,"y":240,"wires":[{"id":"cfd02a2c.1b2b78","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"14204bc3.e267a4","type":"subflow","name":"Safe db query","info":"","category":"","in":[{"x":340,"y":240,"wires":[{"id":"e9e17ecb.cc0b8"}]}],"out":[{"x":680,"y":240,"wires":[{"id":"e9e17ecb.cc0b8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"29f03fb6.bae","type":"subflow","name":"Get owner query","info":"","category":"","in":[{"x":340,"y":260,"wires":[{"id":"a94dad63.eaa89"}]}],"out":[{"x":740,"y":260,"wires":[{"id":"a94dad63.eaa89","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"8ed923c2.404c8","type":"mqtt-broker","name":"MQTT Broker location","broker":"localhost","port":"1881","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"95967b6c.bf4128","type":"ui_tab","name":"Dev","icon":"dashboard","disabled":false,"hidden":false},{"id":"9ab0953a.61aa18","type":"ui_group","name":"Properties","tab":"95967b6c.bf4128","order":1,"disp":true,"width":"6","collapse":false},{"id":"b6f540e1.b4baa","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"1346b680.0c26ca","type":"ui_group","name":"Default","tab":"95967b6c.bf4128","order":2,"disp":true,"width":"6","collapse":false},{"id":"f6210e72.915e1","type":"ui_group","name":"Private","tab":"23b29e69.a69182","order":3,"disp":true,"width":"20","collapse":false},{"id":"99fff7f0.ec79a8","type":"ui_group","name":"Public","tab":"23b29e69.a69182","order":4,"disp":true,"width":"20","collapse":false},{"id":"23b29e69.a69182","type":"ui_tab","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"55af362.e170ec8","type":"consumed-thing","tdLink":"http://192.168.1.128:9001","td":"{\"id\": \"mock:pulse:848e6e4b-0657-4d2f-a049-dddc0067a60f1\", \"classification\": {\"PatientA\": [\"PatientA\", \"Doctors\"]}, \"title\": null, \"@context\": \"https://iot.mozilla.org/schemas\", \"properties\": {\"pulse\": {\"@type\": \"PulseData\", \"title\": \"Pulse\", \"type\": \"float\", \"description\": \"Real time pulse value\", \"readOnly\": true, \"links\": [{\"rel\": \"property\", \"href\": \"/properties/pulse\"}]}}, \"actions\": {}, \"events\": {}, \"links\": [{\"rel\": \"properties\", \"href\": \"/properties\"}, {\"rel\": \"actions\", \"href\": \"/actions\"}, {\"rel\": \"events\", \"href\": \"/events\"}, {\"rel\": \"alternate\", \"href\": \"ws://192.168.1.128:9001/\"}], \"description\": \"A device reporting its position\", \"@type\": [\"DiscretePostitionDevice\"], \"base\": \"http://192.168.1.128:9001/\", \"securityDefinitions\": {\"nosec_sc\": {\"scheme\": \"nosec\"}}, \"security\": \"nosec_sc\"}","http":false,"coap":false,"mqtt":false,"opcua":false,"modbus":false},{"id":"19d3b93f.cd27c7","type":"Stackhero-MySQL-Server","name":"","host":"mariadb","port":"3306","tls":false,"database":"test"},{"id":"2f9284ff.b82f8c","type":"mongodb","hostname":"mongo","topology":"direct","connectOptions":"","port":"27017","db":"test","name":"mongodb-test"},{"id":"f69609b1.cb1968","type":"mongodb","hostname":"mongo","topology":"direct","connectOptions":"","port":"27017","db":"hospital","name":"hospital-db"},{"id":"204bbef6.aa5002","type":"function","z":"84041e35.dbf49","name":"Prepare request","func":"//msg = {}\nmsg.headers=flow.get('HEADERS')\n//msg.headers[\"Accept\"]=\"application/json\"\n//msg.headers['Content-Type']='application/json'\n\n//msg.url = \"http://\" + flow.get('IP') + \":\" + flow.get('PORT')\nmsg.url = flow.get(\"URL\")\n\n//msg.model = msg.url + '/model'\n//msg.properties = msg.url + '/properties'\n//msg.things = msg.url\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":240,"wires":[["3bf3d174.b1247e","6cd5aebd.9aebb"]]},{"id":"afee8501.453d68","type":"inject","z":"84041e35.dbf49","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":120,"y":240,"wires":[["204bbef6.aa5002"]]},{"id":"1f71c413.a67b9c","type":"debug","z":"84041e35.dbf49","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1160,"y":240,"wires":[]},{"id":"3bf3d174.b1247e","type":"http request","z":"84041e35.dbf49","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":580,"y":240,"wires":[["6fe5cbe0.c72f04","acf16de5.89113"]]},{"id":"e0465277.d0737","type":"debug","z":"84041e35.dbf49","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1460,"y":400,"wires":[]},{"id":"e9ba575b.3edfb8","type":"function","z":"84041e35.dbf49","name":"Store devices","func":"function isObject(item) {\n  return (item && typeof item === 'object' && !Array.isArray(item));\n}\n\nfunction mergeDeep(target, source) {\n  let output = Object.assign({}, target);\n  if (isObject(target) && isObject(source)) {\n    Object.keys(source).forEach(key => {\n      if (isObject(source[key])) {\n        if (!(key in target))\n          Object.assign(output, { [key]: source[key] });\n        else\n          output[key] = mergeDeep(target[key], source[key]);\n      } else {\n        Object.assign(output, { [key]: source[key] });\n      }\n    });\n  }\n  return output;\n}\n\nall_devices = flow.get('DEVICES')\ndevice = msg.payload\nif(device.id in all_devices){\n    old_device = all_devices[device.id]\n    new_device = mergeDeep(old_device, device)\n    all_devices[new_device.id]=new_device\n} else{\n    all_devices[device.id] = device\n}\nflow.set('DEVICES', all_devices)\n\nmsg.payload = flow.get('DEVICES')\nreturn msg\nold_devices = flow.get(\"DEVICES\")\n\nlet devices = []\nif(old_devices.length>0){\n    devices = mergeDeep(old_devices, new_devices);\n} else{\n    devices = new_devices\n}\n\nflow.set(\"DEVICES\",devices)\nmsg.payload = devices\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":960,"y":240,"wires":[["1f71c413.a67b9c"]]},{"id":"cbf2b79c.adbb38","type":"inject","z":"84041e35.dbf49","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"60","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":400,"wires":[["6b547395.f8438c"]]},{"id":"6b547395.f8438c","type":"function","z":"84041e35.dbf49","name":"Extract device property data","func":"\n\nproperties = []\ndevices = flow.get('DEVICES')\n\nfor (var id in devices) {\n    for (var key in devices[id].properties) {\n        property = devices[id].properties[key]\n        if('links' in property && property.links!=null && property.links.length>0){\n            prop = {};\n            prop.device_id = devices[id].id\n            prop.name = key\n            prop.value = devices[id].properties[key]\n            properties.push(prop)\n        }\n    }\n}\nmsg.payload = properties\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":400,"wires":[["7754fc18.f1e244"]]},{"id":"7b7f7145.329b1","type":"debug","z":"84041e35.dbf49","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1110,"y":460,"wires":[]},{"id":"383e2e1b.805fc2","type":"function","z":"84041e35.dbf49","name":"Prepare request","func":"\nmsg.headers=flow.get('HEADERS')\n//base = \"http://\" + flow.get('IP') + \":\" + flow.get('PORT')\nbase = flow.get('URL')\n\nurl = base + msg.payload.value.links[0].href\nmsg.device_id = msg.payload.device_id\nmsg.property = msg.payload.name\n//msg.url = base + msg.payload.value.links[0]\n\nmsg.url = url\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":730,"y":400,"wires":[["f79a6e54.4647e"]]},{"id":"7754fc18.f1e244","type":"split","z":"84041e35.dbf49","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":550,"y":400,"wires":[["383e2e1b.805fc2","6df49ee3.c1e1d"]]},{"id":"f79a6e54.4647e","type":"http request","z":"84041e35.dbf49","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":940,"y":400,"wires":[["ee6a8775.054288","7b7f7145.329b1"]]},{"id":"ee6a8775.054288","type":"function","z":"84041e35.dbf49","name":"Update device propety values","func":"\n\ndevices = flow.get('DEVICES')\ndevice = devices[msg.device_id]\nname = Object.keys(msg.payload)[0]\nvalue = msg.payload[name]\ndevice.properties[name].value = value\nmsg.payload = device\n\nreturn msg;\n\nfor (i=0;i<devices.length;i++){\n    if(devices[i].id==msg.device_id){\n        device = devices[i]\n        name = Object.keys(msg.payload)[0]\n        value = msg.payload[name]\n        device.properties[name].value = value\n        msg.payload = device\n        break;\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1200,"y":400,"wires":[["e0465277.d0737"]]},{"id":"5e72426a.df850c","type":"function","z":"84041e35.dbf49","name":"Get devices","func":"msg.payload = flow.get('DEVICES')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":700,"wires":[["d8ccd2f.23c6d3"]]},{"id":"d8ccd2f.23c6d3","type":"debug","z":"84041e35.dbf49","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":520,"y":760,"wires":[]},{"id":"cdb44306.6eab","type":"inject","z":"84041e35.dbf49","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":110,"y":700,"wires":[["5e72426a.df850c"]]},{"id":"480501a6.24e44","type":"comment","z":"84041e35.dbf49","name":"Fetch devices","info":"This flow requst device data from the web of things endpoint.\n\nNote that all device data will be replaced and hence the data value will be missing","x":110,"y":200,"wires":[]},{"id":"2cce0935.d1e1e6","type":"comment","z":"84041e35.dbf49","name":"Fetch property data","info":"This flow will use the previous fetched devices to pull data values for each property.\n\nThe values will be added to te property objecs as 'value'","x":130,"y":360,"wires":[]},{"id":"c4da40b8.6160d","type":"comment","z":"84041e35.dbf49","name":"DEBUG: Check status of current devices","info":"This flow is just showing the full device object that exists in memory","x":200,"y":660,"wires":[]},{"id":"4c5b8d33.2da294","type":"function","z":"f088168c.08c968","name":"Thingsboard base setup","func":"//_IP = '192.168.1.83'\n//_PORT = 9090\n\n//flow.set('IP',_IP)\n//flow.set('PORT',_PORT)\n//flow.set('BASE_URL', 'http://' + _IP + ':' + _PORT)\nflow.set('URL', global.get('THINGSBOARD_URL'))\n\n_headers = {\n    \"Accept\": \"application/json\", \n    'Content-Type': 'application/json'\n}\n\nflow.set('BASE_HEADERS', _headers)\n\nauth_headers = _headers\nif(flow.get('TOKEN')){\n    token = flow.get('TOKEN')\n    auth_headers['X-Authorization'] = 'Bearer ' + token\n}\nflow.set('HEADERS', auth_headers)\n\nmsg.payload = flow.get('HEADERS')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":80,"wires":[["76cd4e17.aa0b"]]},{"id":"53a9f200.4a073","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"2","topic":"","payload":"","payloadType":"date","x":130,"y":360,"wires":[["5bfe6e82.1e21d"]]},{"id":"5bfe6e82.1e21d","type":"function","z":"f088168c.08c968","name":"","func":"\n//url = flow.get('BASE_URL') + '/api/auth/login'\nurl = flow.get('URL') + '/api/auth/login'\nheaders = flow.get('BASE_HEADERS')\n\npayload = {\n    \"username\":\"tenant@thingsboard.org\", \n    \"password\":\"tenant\"\n}\n\nmsg.url = url\nmsg.headers = headers\nmsg.payload = payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":360,"y":360,"wires":[["228aada7.41f302","78e7f8e2.e91838"]]},{"id":"228aada7.41f302","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":540,"y":360,"wires":[["94ee4274.cd55d","79b36c1e.45d4f4"]]},{"id":"b1d6cf31.ffd75","type":"comment","z":"f088168c.08c968","name":"Update api auth token and headers","info":"","x":190,"y":320,"wires":[]},{"id":"b6d632f4.66e14","type":"function","z":"f088168c.08c968","name":"Store token in flow scope","func":"\nflow.set('TOKEN', msg.payload.token)\n\n// Update headers\nheaders = flow.get('HEADERS')\nheaders['X-Authorization'] = 'Bearer ' + flow.get('TOKEN')\nflow.set('HEADERS', headers)\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":360,"wires":[["b539883.bd83678"]]},{"id":"d20c95d.6708868","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":160,"y":80,"wires":[["4c5b8d33.2da294"]]},{"id":"76cd4e17.aa0b","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":720,"y":80,"wires":[]},{"id":"c3d2d9ed.0c5278","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":130,"y":460,"wires":[["a737f169.afadc"]]},{"id":"f6c2049.0d9ddf8","type":"split","z":"f088168c.08c968","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":650,"y":460,"wires":[["a5218fd2.c8729","eb4b3250.00103"]]},{"id":"eb4b3250.00103","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"DEVICE_TYPE = 'wot-device'\n\npayload = {\n        \"name\":msg.payload.id,\n        \"type\":DEVICE_TYPE\n    }\n\nmsg.payload = payload\nmsg.headers = flow.get('HEADERS')\nmsg.url = flow.get('URL') + '/api/device'\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":830,"y":460,"wires":[["aed74c31.93a8f"]]},{"id":"aed74c31.93a8f","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1040,"y":460,"wires":[["31f46af2.997e56","a391ce62.c1f76","33044468.b4a3ac"]]},{"id":"7d531b1d.f543e4","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1390,"y":480,"wires":[]},{"id":"30dc16f2.7faf1a","type":"inject","z":"84041e35.dbf49","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":520,"wires":[["8b80f4b.a736008"]]},{"id":"8b80f4b.a736008","type":"function","z":"84041e35.dbf49","name":"Put devices in global scope","func":"\nfunction isObject(item) {\n  return (item && typeof item === 'object' && !Array.isArray(item));\n}\n\nfunction mergeDeep(target, source) {\n  let output = Object.assign({}, target);\n  if (isObject(target) && isObject(source)) {\n    Object.keys(source).forEach(key => {\n      if (isObject(source[key])) {\n        if (!(key in target))\n          Object.assign(output, { [key]: source[key] });\n        else\n          output[key] = mergeDeep(target[key], source[key]);\n      } else {\n        Object.assign(output, { [key]: source[key] });\n      }\n    });\n  }\n  return output;\n}\n\nold_devices = global.get(\"DEVICES\")\nnew_devices = flow.get(\"DEVICES\")\n\nlet devices = []\nif(old_devices.length>0){\n    devices = mergeDeep(old_devices, new_devices);\n} else{\n    devices = new_devices\n}\n\nglobal.set(\"DEVICES\",devices)\nmsg.payload = global.get('DEVICES')\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":540,"wires":[["d4ee2922.672108"]]},{"id":"d4ee2922.672108","type":"debug","z":"84041e35.dbf49","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":780,"y":540,"wires":[]},{"id":"a737f169.afadc","type":"function","z":"f088168c.08c968","name":"Filter devices without thingsboard id","func":"\ndevices = []\nall_devices =  global.get('DEVICES')\n\nfor (var id in all_devices){\n    if(!all_devices[id].thingsboard_id){\n        devices.push(all_devices[id])\n    }\n}\n//for (i=0; i<all_devices.length; i++){\n//    if(!all_devices[i].thingsboard_id){\n//        devices.push(all_devices[i])\n//    }\n//}\n\nmsg.payload = devices\n//msg.payload = global.get('DEVICES')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":460,"wires":[["f6c2049.0d9ddf8"]]},{"id":"a5218fd2.c8729","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":770,"y":520,"wires":[]},{"id":"31f46af2.997e56","type":"switch","z":"f088168c.08c968","name":"HTTP 200","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1230,"y":440,"wires":[["699b7af4.6b49d4"]]},{"id":"a391ce62.c1f76","type":"switch","z":"f088168c.08c968","name":"HTTP Error","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1230,"y":480,"wires":[["7d531b1d.f543e4"]]},{"id":"e5325f28.043d9","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1650,"y":440,"wires":[]},{"id":"699b7af4.6b49d4","type":"function","z":"f088168c.08c968","name":"Store device thingsboard id","func":"\ndevices = global.get('DEVICES')\n\npayload = {}\n\nif (msg.payload.name in devices){\n    device = devices[msg.payload.name]\n    device.thingsboard_id = msg.payload.id.id\n    payload = devices[msg.payload.name]\n}\n\n/*\nfor (i=0; i<devices.length; i++){\n    if (devices[i].id == msg.payload.name){\n        devices[i].thingsboard_id = msg.payload.id.id\n        payload = devices[i]\n        break;\n    }\n}\n*/\nmsg.payload = payload\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1450,"y":440,"wires":[["e5325f28.043d9"]]},{"id":"df03fff0.28454","type":"function","z":"f088168c.08c968","name":"Get devices","func":"msg.payload = global.get('DEVICES')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":390,"y":2160,"wires":[["c673e532.bd9b58"]]},{"id":"c673e532.bd9b58","type":"debug","z":"f088168c.08c968","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":640,"y":2160,"wires":[]},{"id":"dde0a846.6cc358","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":2160,"wires":[["df03fff0.28454"]]},{"id":"485d22a8.54672c","type":"comment","z":"f088168c.08c968","name":"DEBUG: Check status of current GLOBAL devices","info":"This flow is just showing the full device object that exists in memory","x":290,"y":2120,"wires":[]},{"id":"9c5908b5.671c08","type":"comment","z":"f088168c.08c968","name":"Create thingsboard devices","info":"","x":170,"y":420,"wires":[]},{"id":"5eceb5e6.f8025c","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"15","topic":"","payload":"","payloadType":"date","x":170,"y":1140,"wires":[["130bb259.00f70e"]]},{"id":"130bb259.00f70e","type":"function","z":"f088168c.08c968","name":"Filter public devices","func":"\ndevices = []\nall_devices =  Object.values(global.get('DEVICES'))\n\nfor (i=0; i<all_devices.length; i++){\n    if(all_devices[i].classification.includes('public')){\n        devices.push(all_devices[i])\n    }\n}\n\nmsg.all = all_devices\nmsg.payload = devices\n\n//msg.payload = global.get('DEVICES')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":1140,"wires":[["4b7f4f8f.9620b","498b0e.732274f4"]]},{"id":"1206ebf8.805234","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1070,"y":1180,"wires":[]},{"id":"498b0e.732274f4","type":"split","z":"f088168c.08c968","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":630,"y":1140,"wires":[["1edc2865.cd3928"]]},{"id":"1edc2865.cd3928","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"\n\nmsg.url = flow.get('URL') +  '/api/customer/public/device/' + msg.payload.thingsboard_id\nmsg.headers = flow.get('HEADERS')\n\nmsg.device_id = msg.payload.id\n\nreturn msg;\n\ndevice_id_map = {\n    'urn:dev:ops:fake-thermo-1': '30bfb4a0-d710-11ea-b079-cd5e832a839a',\n    'urn:dev:ops:fake-thermo-2': '30bfb4a1-d710-11ea-b079-cd5e832a839a'\n}\n\nfor (i=0; i<msg.payload.length; i++){\n    customer = msg.payload[i]\n    customerId = customer.id\n    for (j=0; j<customer.devices.length; j++){\n        device = customer.devices[j]\n        deviceId = device_id_map[device.id]\n        request = {}\n        request.url = base_url + customerId + '/device/' + deviceId\n        request.headers = msg.setup.auth_headers\n        request_data.push(request)\n    }\n}\nmsg.payload = request_data\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":870,"y":1140,"wires":[["1206ebf8.805234","e33874ab.9d7948"]]},{"id":"e33874ab.9d7948","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1120,"y":1140,"wires":[["f9f766fd.e01288"]]},{"id":"6422553d.970a7c","type":"debug","z":"f088168c.08c968","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1460,"y":1180,"wires":[]},{"id":"f9f766fd.e01288","type":"json","z":"f088168c.08c968","name":"","property":"payload","action":"","pretty":false,"x":1290,"y":1140,"wires":[["6422553d.970a7c"]]},{"id":"ebc5891d.5ad5e8","type":"comment","z":"f088168c.08c968","name":"Assign public devices","info":"","x":180,"y":1100,"wires":[]},{"id":"13baf679.cc046a","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"\nbase_url = flow.get('BASE_URL') + '/api/customer/'\ncustomerId = msg.payload.assign_to\ndeviceId = msg.payload.device.thingsboard_id\n\nmsg.url = base_url + customerId + '/device/' + deviceId\n\nmsg.headers = flow.get('HEADERS')\n\nmsg.payload = {}\n\nreturn msg\nfor (i=0; i<msg.payload.length; i++){\n    customer = msg.payload[i]\n    customerId = customer.id\n    for (j=0; j<customer.devices.length; j++){\n        device = customer.devices[j]\n        deviceId = device_id_map[device.id]\n        request = {}\n        request.url = base_url + customerId + '/device/' + deviceId\n        request.headers = msg.setup.auth_headers\n        request_data.push(request)\n    }\n}\nmsg.payload = request_data\nreturn msg;\n\n\n\nbase_url = msg.setup.url + '/api/customer/'\n\n///api/customer/{customerId}/device/{deviceId}\nrequest_data = []\n\ndevice_id_map = {\n    'urn:dev:ops:fake-thermo-1': '30bfb4a0-d710-11ea-b079-cd5e832a839a',\n    'urn:dev:ops:fake-thermo-2': '30bfb4a1-d710-11ea-b079-cd5e832a839a'\n}\n\nfor (i=0; i<msg.payload.length; i++){\n    customer = msg.payload[i]\n    customerId = customer.id\n    for (j=0; j<customer.devices.length; j++){\n        device = customer.devices[j]\n        deviceId = device_id_map[device.id]\n        request = {}\n        request.url = base_url + customerId + '/device/' + deviceId\n        request.headers = msg.setup.auth_headers\n        request_data.push(request)\n    }\n}\nmsg.payload = request_data\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1090,"y":1220,"wires":[[]]},{"id":"d6fbebec.561278","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"60","crontab":"","once":false,"onceDelay":"15","topic":"","payload":"","payloadType":"date","x":180,"y":1260,"wires":[[]]},{"id":"87ce5a85.967ca8","type":"function","z":"f088168c.08c968","name":"Filter non-public devices","func":"// Needs device id and customer id\n\n\nclassificationCustomerMap = {\n    'CustomerA':'Customer A',\n    'CustomerB':'Customer B',\n    'CustomerC':'Customer C',\n}\n\ndevices =  Object.values(global.get('DEVICES'))\ncustomers = flow.get('CUSTOMERS')\n\npayload = []\nfor (i=0; i<devices.length; i++){\n    for(j=0; j<customers.length; j++){\n           device = devices[i];\n           customer = customers[j]\n           classifications = device.classification\n           for(k=0; k<classifications.length; k++){\n               c = classifications[k];\n               if(classificationCustomerMap[c]==customer.name){\n                   assignment = {\n                       'deviceId':device.thingsboard_id,\n                       'customerId':customer.id.id\n                   }\n                   payload.push(assignment);\n               }\n           }\n    }\n}\n\n//msg.devices = devices;\n//msg.customers = customers;\nmsg.payload = payload;\n//msg.payload = global.get('DEVICES')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":1260,"wires":[["93284b1.05083b8"]]},{"id":"93284b1.05083b8","type":"split","z":"f088168c.08c968","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":630,"y":1260,"wires":[["e7334875.c49738","37d504c7.6a090c"]]},{"id":"300d237e.b3673c","type":"comment","z":"f088168c.08c968","name":"Assign non-public devices","info":"","x":200,"y":1220,"wires":[]},{"id":"57a46915.afdf18","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1670,"y":1300,"wires":[]},{"id":"e3c5cb2b.770558","type":"function","z":"f088168c.08c968","name":"Look-up privileges","func":"access_map = {\n    'private':'e9bc6df0-d705-11ea-a598-c5ae97ecd5e5' // Customer A\n}\n\npayload = {}\n\nif(msg.payload.classification in access_map){\n    payload.device = msg.payload\n    payload.assign_to = access_map[msg.payload.classification]\n}\n\n\nmsg.payload = payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":1220,"wires":[[]]},{"id":"eb3d9858.d53218","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1360,"y":1260,"wires":[["384d3414.4017dc"]]},{"id":"384d3414.4017dc","type":"json","z":"f088168c.08c968","name":"","property":"payload","action":"","pretty":false,"x":1550,"y":1260,"wires":[["57a46915.afdf18"]]},{"id":"73e6b1cf.966bd","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"base_url = flow.get('URL') + '/api/v1/'\n\n//msg.url = flow.get('BASE_URL') + '/api/v1/telemetry'\nmsg.headers = flow.get('HEADERS')\n\n//base_url + '/' + token + endpoint\nmsg.url = base_url + msg.payload.thingsboard_token + '/telemetry'\n\nproperties = msg.payload.properties\n\ndata = {}\nObject.keys(properties).forEach(function(key) {\n    value = properties[key].value\n    data[key] = value\n});\n\nmsg.payload = data\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":830,"y":1420,"wires":[["7b0d15df.18c4ac","d3e3751d.297d98"]]},{"id":"c31976a.7712788","type":"function","z":"f088168c.08c968","name":"Get devices","func":"devices = []\nall_devices =  global.get('DEVICES')\n\nfor (var id in all_devices){\n    if(all_devices[id].thingsboard_id){\n        devices.push(all_devices[id])\n    }\n}\nmsg.payload = devices\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":390,"y":1420,"wires":[["aa416cd2.48b79"]]},{"id":"e36403b7.c9cfe","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":1420,"wires":[["c31976a.7712788"]]},{"id":"c660bc7.5b6b04","type":"comment","z":"f088168c.08c968","name":"Update data","info":"Push data to thingsboard","x":160,"y":1380,"wires":[]},{"id":"7b0d15df.18c4ac","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1050,"y":1520,"wires":[]},{"id":"aa416cd2.48b79","type":"split","z":"f088168c.08c968","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":590,"y":1420,"wires":[["73e6b1cf.966bd","b773bb51.a10ac8","da846d5b.8d51b"]]},{"id":"1532c584.92164a","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":620,"wires":[["3b4c58df.91a628"]]},{"id":"dd86198e.6c76a8","type":"split","z":"f088168c.08c968","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":530,"y":620,"wires":[["d88b98b.6a7b168","10b91a9c.32dd25"]]},{"id":"d88b98b.6a7b168","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"base_url = flow.get('URL')\n\ndeviceId = msg.payload.thingsboard_id\n\nmsg.url = base_url + '/api/device/' + deviceId + '/credentials'\nmsg.headers = flow.get('HEADERS')\n\nmsg.device_id = msg.payload.id\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":770,"y":620,"wires":[["ec29a6b9.b978c8","87c8dcd8.e4d8f"]]},{"id":"3b4c58df.91a628","type":"function","z":"f088168c.08c968","name":"Get devices","func":"\n//msg.payload =  global.get('DEVICES')\n\ndevices = []\nall_devices =  global.get('DEVICES')\n\nfor (var id in all_devices){\n    if(all_devices[id].thingsboard_id){\n        devices.push(all_devices[id])\n    }\n}\nmsg.payload = devices\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":620,"wires":[["dd86198e.6c76a8"]]},{"id":"8bb77706.b99758","type":"comment","z":"f088168c.08c968","name":"Get thingsboard device credentials","info":"","x":230,"y":580,"wires":[]},{"id":"ec29a6b9.b978c8","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":930,"y":660,"wires":[]},{"id":"87c8dcd8.e4d8f","type":"http request","z":"f088168c.08c968","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1040,"y":620,"wires":[["6525e188.27fb6","15dc2032.0f95d"]]},{"id":"6525e188.27fb6","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1190,"y":660,"wires":[]},{"id":"15dc2032.0f95d","type":"function","z":"f088168c.08c968","name":"Store device access token","func":"\ndevices = global.get('DEVICES')\n\npayload = {}\n\nif (msg.device_id in devices){\n    device = devices[msg.device_id]\n    device.thingsboard_token = msg.payload.credentialsId\n    payload = devices[msg.device_id]\n}\n\n/*\nfor (i=0; i<devices.length; i++){\n    if (devices[i].id == msg.device_id){\n        devices[i].thingsboard_token = msg.payload.credentialsId\n        payload = devices[i]\n        break;\n    }\n}\n*/\nmsg.payload = payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1320,"y":620,"wires":[["97d758cc.5b4ad8","ae6077bf.9d5a38"]]},{"id":"97d758cc.5b4ad8","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1560,"y":660,"wires":[]},{"id":"b773bb51.a10ac8","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":810,"y":1520,"wires":[]},{"id":"d3e3751d.297d98","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1160,"y":1420,"wires":[["fba6e074.d4b19"]]},{"id":"fba6e074.d4b19","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1330,"y":1480,"wires":[]},{"id":"43cab8d7.1e80f8","type":"complete","z":"84041e35.dbf49","name":"","scope":["e9ba575b.3edfb8"],"uncaught":false,"x":110,"y":440,"wires":[["6b547395.f8438c"]]},{"id":"3b2e3ed3.c72ed2","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"\nmsg.url = flow.get('BASE_URL') + '/api/dashboard'\nmsg.headers = flow.get('HEADERS')\n\n\ntitle = \"DASHBOARD\"\nname = title\ndescription = \"Some description\"\n\ndashboard_conf = {\n    \"title\":title,\n    \"configuration\":{\n        \"description\":description\n    },\n    \"name\":name\n}\n\n\nmsg.payload = dashboard_conf\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":1660,"wires":[["1a86808d.ec24ef","f01260d1.5d81f"]]},{"id":"250c0c6e.3e41a4","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":1660,"wires":[["3b2e3ed3.c72ed2"]]},{"id":"a2dab0e2.5a711","type":"comment","z":"f088168c.08c968","name":"Create dashboard","info":"","x":190,"y":1620,"wires":[]},{"id":"84262a26.70baa8","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":950,"y":1740,"wires":[]},{"id":"1a86808d.ec24ef","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":670,"y":1720,"wires":[]},{"id":"f01260d1.5d81f","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":720,"y":1660,"wires":[["84262a26.70baa8","3e919339.2ecadc"]]},{"id":"3e919339.2ecadc","type":"function","z":"f088168c.08c968","name":"Store dashboard conf","func":"\nflow.set('DASHBOARD', msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1010,"y":1660,"wires":[[]]},{"id":"b8f7d1ac.a7679","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"\ndashboard = flow.get('DASHBOARD')\ndashboardId = dashboard.id.id\nmsg.url = flow.get('BASE_URL') + '/api/dashboard/' + dashboardId + '/customers'\nmsg.headers = flow.get('HEADERS')\n\ncustomers = [\n    'e9bc6df0-d705-11ea-a598-c5ae97ecd5e5', // A\n    'e9c3c0f0-d705-11ea-a598-c5ae97ecd5e5', // B\n    'e9c4f970-d705-11ea-a598-c5ae97ecd5e5'  // C\n]\n\nmsg.payload = customers\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":2020,"wires":[["c66ca9fa.d7a3f8","8c7c9782.d15f28"]]},{"id":"b01d491a.6a8c18","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":2020,"wires":[["b8f7d1ac.a7679"]]},{"id":"8b3ef508.1d94d8","type":"comment","z":"f088168c.08c968","name":"Assign dashboard to customers","info":"","x":240,"y":1980,"wires":[]},{"id":"c66ca9fa.d7a3f8","type":"debug","z":"f088168c.08c968","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":670,"y":2080,"wires":[]},{"id":"8c7c9782.d15f28","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":780,"y":2020,"wires":[["e3b67001.e1c28"]]},{"id":"7ad246ed.591d28","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"\nmsg.url = flow.get('URL') + '/api/customers' + '?pageSize=3&page=0&limit=10'\n//{?textSearch,sortProperty,sortOrder,pageSize,page}'\n\nmsg.headers = flow.get('HEADERS')\nmsg.headers[\"Accept\"] = \"*/*\"\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":490,"y":1900,"wires":[["3009858b.dfc5da","87aecfdd.5fd08"]]},{"id":"ac5ad9f0.9d2f48","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"60","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":220,"y":1900,"wires":[[]]},{"id":"59d4c11f.5e961","type":"comment","z":"f088168c.08c968","name":"Get customers","info":"","x":200,"y":1860,"wires":[]},{"id":"3009858b.dfc5da","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":690,"y":1960,"wires":[]},{"id":"87aecfdd.5fd08","type":"http request","z":"f088168c.08c968","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":740,"y":1900,"wires":[["31a41763.873b78"]]},{"id":"d92e281f.5a1ef8","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1240,"y":1900,"wires":[]},{"id":"e3b67001.e1c28","type":"debug","z":"f088168c.08c968","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1070,"y":2100,"wires":[]},{"id":"aa082a11.6d2328","type":"complete","z":"84041e35.dbf49","name":"","scope":["ee6a8775.054288"],"uncaught":false,"x":140,"y":580,"wires":[["8b80f4b.a736008"]]},{"id":"87bcb546.b4b0b8","type":"inject","z":"84041e35.dbf49","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":80,"wires":[["867983a2.7a538"]]},{"id":"867983a2.7a538","type":"function","z":"84041e35.dbf49","name":"Delete local and global device data","func":"\nflow.set(\"DEVICES\",{})\nglobal.set(\"DEVICES\",{})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":80,"wires":[[]]},{"id":"d0dc5fa2.61f6a","type":"comment","z":"84041e35.dbf49","name":"Clear devices [DONT DO THIS]","info":"","x":210,"y":40,"wires":[]},{"id":"17b03eb1.53c301","type":"inject","z":"89ad9af9.5b24b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":160,"wires":[["e3346cfa.6fdb"]]},{"id":"e3346cfa.6fdb","type":"function","z":"89ad9af9.5b24b8","name":"Set up global parameters","func":"wot_url = 'http://wot'+':8888'\n\nwebthings = [\n    'http://patient-a'+':8888',\n    'http://patient-b'+':8888',\n    'http://patient-c'+':8888'\n    ]\nglobal.set(\"WOT_HOSTS\",webthings)\n\n\n// Taxi endpoints\ntaxi_hosts = [\n    'http://taxi-a1'+':8888',\n    'http://taxi-a2'+':8888',\n    'http://taxi-b1'+':8888',\n    'http://taxi-b2'+':8888',\n    'http://taxi-c1'+':8888',\n    'http://taxi-c2'+':8888'\n]\nglobal.set(\"TAXI_WOT_HOSTS\",taxi_hosts)\n\nthingsboard_url = 'http://thingsboard'+':9090'\n\nglobal.set(\"WOT_URL\",wot_url)\nglobal.set(\"THINGSBOARD_URL\",thingsboard_url)\n\nif(!global.get(\"DEVICES\")){\n    global.set(\"DEVICES\",[])\n}\n\nif(!global.get(\"HOSPITAL_MEAN\")){\n    global.set(\"HOSPITAL_MEAN\",{})\n}\n\nglobal_state = {}\nglobal_keys = global.keys()\nfor (i=0; i<global_keys.length; i++){\n    key = global_keys[i];\n    global_state[key]=global.get(key);\n}\nmsg.payload = global_state;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":160,"wires":[["69806943.4d8f38"]]},{"id":"1272342b.aceabc","type":"inject","z":"84041e35.dbf49","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":110,"y":140,"wires":[["e5111f80.ab1ca"]]},{"id":"e5111f80.ab1ca","type":"function","z":"84041e35.dbf49","name":"Local setup","func":"flow.set(\"URL\", global.get(\"WOT_URL\"))\nflow.set(\"HEADERS\", {\"Accept\": \"application/json\", 'Content-Type': 'application/json'})\n\nmsg.payload = flow.get('URL')\n\nif(!flow.get(\"DEVICES\")){\n    flow.set(\"DEVICES\",{})\n}\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":140,"wires":[["303beea9.0117b2"]]},{"id":"b539883.bd83678","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1200,"y":360,"wires":[]},{"id":"303beea9.0117b2","type":"debug","z":"84041e35.dbf49","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":540,"y":140,"wires":[]},{"id":"6cd5aebd.9aebb","type":"debug","z":"84041e35.dbf49","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":470,"y":300,"wires":[]},{"id":"6fe5cbe0.c72f04","type":"debug","z":"84041e35.dbf49","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":780,"y":280,"wires":[]},{"id":"56a5f4ac.2b680c","type":"function","z":"141904da.18313b","name":"Get devices","func":"TYPE = 'DiscretePositionDevice'\n\nall_devices = flow.get('DEVICES')\n\ndevices = []\nfor (id in all_devices){\n    if(true || TYPE in all_devices[id]['@type']){\n        devices.push(all_devices[id])\n    }\n}\nmsg.payload = devices\n//msg.payload = all_devices.length\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":160,"wires":[["8cf68a71.de2b18","2ef25155.38b93e"]]},{"id":"8cf68a71.de2b18","type":"debug","z":"141904da.18313b","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":560,"y":220,"wires":[]},{"id":"7774e15a.d8703","type":"inject","z":"141904da.18313b","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"10","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":160,"wires":[["56a5f4ac.2b680c"]]},{"id":"cd67c46d.a7ba48","type":"function","z":"141904da.18313b","name":"Local setup","func":"\nflow.set(\"DEVICES\",global.get('DEVICES'))\n\nmsg.payload = flow.get(\"DEVICES\")\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":80,"wires":[["8b4450bd.038df"]]},{"id":"eac35d47.f3d38","type":"inject","z":"141904da.18313b","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":130,"y":80,"wires":[["cd67c46d.a7ba48"]]},{"id":"8b4450bd.038df","type":"debug","z":"141904da.18313b","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":600,"y":80,"wires":[]},{"id":"acf16de5.89113","type":"split","z":"84041e35.dbf49","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":750,"y":240,"wires":[["a1835bf1.47c718","e9ba575b.3edfb8"]]},{"id":"a1835bf1.47c718","type":"debug","z":"84041e35.dbf49","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":960,"y":200,"wires":[]},{"id":"6df49ee3.c1e1d","type":"debug","z":"84041e35.dbf49","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":740,"y":440,"wires":[]},{"id":"2ef25155.38b93e","type":"function","z":"141904da.18313b","name":"Compute distribution","func":"\nn_zones = 4\ncar_distribution = {}\nfor(i=1; i<=n_zones; i++){\n    car_distribution[i] = 0\n}\n\ndevices = []\nfor (i=0;i<msg.payload.length; i++){\n device = msg.payload[i];\n if(typeof device !== 'object'){\n     continue;\n }\n \n if (device === null){\n     continue;\n }\n \n if ('properties' in device && 'position' in device.properties){\n    devices.push(device);\n }\n \n}\nmsg.devices = devices;\n\nfor (i=0;i<devices.length; i++){\n    device = devices[i];\n    value = device.properties['position'].value\n    car_distribution[value] = car_distribution[value] + 1\n}\nmsg.payload = car_distribution\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":630,"y":160,"wires":[["9275a202.a0eec","6cdcbc10.b62394"]]},{"id":"9275a202.a0eec","type":"debug","z":"141904da.18313b","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":850,"y":220,"wires":[]},{"id":"6cdcbc10.b62394","type":"function","z":"141904da.18313b","name":"Create global distribution object","func":"\nid='car_distribution_1';\n\nif(!global.get(\"DEVICES\")[id]){\n    distribution_object = {\n        'id':id,\n        'classification':['public'],\n        'title': 'Car distribution',\n        'properties':{\n            '1':{\n                'title':'Cars at zone 1',\n                'type': 'int',\n                'description': 'Number of cars at zone 1',\n                'readOnly': true,\n                'links': null,\n                'value': msg.payload['1']\n            },\n            '2':{\n                'title':'Cars at zone 2',\n                'type': 'int',\n                'description': 'Number of cars at zone 2',\n                'readOnly': true,\n                'links': null,\n                'value': msg.payload['2']\n            },\n            '3':{\n                'title':'Cars at zone 3',\n                'type': 'int',\n                'description': 'Number of cars at zone 3',\n                'readOnly': true,\n                'links': null,\n                'value': msg.payload['3']\n            },\n            '4':{\n                'title':'Cars at zone 4',\n                'type': 'int',\n                'description': 'Number of cars at zone 4',\n                'readOnly': true,\n                'links': null,\n                'value': msg.payload['4']\n            }\n        }\n    };\n} else {\n    distribution_object = global.get('DEVICES')[id];\n}\n\nproperties = distribution_object['properties']\ndelete properties.distribution\n\nfor (let [key, value] of Object.entries(msg.payload)){\n    property = {\n                'title':'Cars at zone ' + key,\n                'type': 'int',\n                'description': 'Number of cars at zone ' + key,\n                'readOnly': true,\n                'links': null,\n                'value': msg.payload[key]\n            }\n    properties[key]=property;\n}\ndistribution_object['properties']=properties;\n\ndevices = global.get('DEVICES')\ndevices[id] = distribution_object;\nglobal.set('DEVICES', devices);\nglobal.set('DISTRIBUTION', undefined);\n\nmsg.payload = global.get('DEVICES')[id];\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":950,"y":160,"wires":[["642de9b0.a76888"]]},{"id":"642de9b0.a76888","type":"debug","z":"141904da.18313b","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1220,"y":240,"wires":[]},{"id":"5622291b.060618","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":860,"wires":[["d6c467a7.ded8e8"]]},{"id":"26a97409.11272c","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"DEVICE_TYPE = 'CAR_DISTRIBUTION'\n\npayload = {\n        \"name\":msg.payload.id,\n        \"type\":DEVICE_TYPE\n    }\n\nmsg.distribution = msg.payload\n\nmsg.payload = payload\nmsg.headers = flow.get('HEADERS')\nmsg.url = flow.get('URL') + '/api/device'\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":590,"y":860,"wires":[["ada86913.f7d6b8","d5b4a661.70e418"]]},{"id":"a4b7c7ed.77c618","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1060,"y":820,"wires":[["a0199646.cdeea8","a19c5ea9.3c709"]]},{"id":"a1a96c47.cd939","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1450,"y":840,"wires":[]},{"id":"d6c467a7.ded8e8","type":"function","z":"f088168c.08c968","name":"Get distribution","func":"\ncar_distribution =  global.get('DISTRIBUTION')\n\ncar_distribution.thingsboard_id = '59592b80-e54d-11ea-9e40-51dfa88a126f'\n\nmsg.payload = car_distribution\n\n\n\n//msg.payload = global.get('DEVICES')\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":860,"wires":[["55eab445.b91d8c","26a97409.11272c"]]},{"id":"55eab445.b91d8c","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":590,"y":940,"wires":[]},{"id":"a0199646.cdeea8","type":"switch","z":"f088168c.08c968","name":"HTTP 200","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1290,"y":800,"wires":[["f4d12c28.9a338"]]},{"id":"a19c5ea9.3c709","type":"switch","z":"f088168c.08c968","name":"HTTP Error","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1290,"y":840,"wires":[["a1a96c47.cd939"]]},{"id":"410a8081.dd868","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1750,"y":800,"wires":[]},{"id":"f4d12c28.9a338","type":"function","z":"f088168c.08c968","name":"Store device thingsboard id","func":"\ncar_distribution =  global.get('DISTRIBUTION')\ncar_distribution['thingsboard_id'] = msg.payload.id.id\n\nmsg.payload = car_distribution\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1530,"y":800,"wires":[["410a8081.dd868"]]},{"id":"f9bc775.70c6488","type":"comment","z":"f088168c.08c968","name":"Update car distribution","info":"","x":170,"y":820,"wires":[]},{"id":"ada86913.f7d6b8","type":"switch","z":"f088168c.08c968","name":"Device exists","property":"distribution.thingsboard_id","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":820,"y":880,"wires":[["806fd2d1.418ba","f1423129.70b33"]]},{"id":"d5b4a661.70e418","type":"switch","z":"f088168c.08c968","name":"Create device","property":"distribution.thingsboard_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":820,"y":820,"wires":[["740aab60.9791e4","a4b7c7ed.77c618"]]},{"id":"806fd2d1.418ba","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"distribution","targetType":"msg","statusVal":"","statusType":"auto","x":1050,"y":940,"wires":[]},{"id":"740aab60.9791e4","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"distribution","targetType":"msg","statusVal":"","statusType":"auto","x":1070,"y":780,"wires":[]},{"id":"f1423129.70b33","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"base_url = flow.get('URL') + '/api/v1/'\n\n//msg.url = flow.get('BASE_URL') + '/api/v1/telemetry'\nmsg.headers = flow.get('HEADERS')\n\n//base_url + '/' + token + endpoint\nmsg.distribution.thingsboard_token = 'QmiLR0bmWjiBzC1O6Fkq'\n\nmsg.url = base_url + msg.distribution.thingsboard_token + '/telemetry'\n\ndata = msg.distribution['value']\n\nmsg.payload = data\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":880,"wires":[["48d76692.51f398","983f703d.2fc91"]]},{"id":"983f703d.2fc91","type":"http request","z":"f088168c.08c968","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1330,"y":880,"wires":[["48d76692.51f398"]]},{"id":"48d76692.51f398","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1490,"y":940,"wires":[]},{"id":"33044468.b4a3ac","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1310,"y":540,"wires":[]},{"id":"10b91a9c.32dd25","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":710,"y":680,"wires":[]},{"id":"da85342.dce8ec8","type":"complete","z":"f088168c.08c968","name":"","scope":["e36403b7.c9cfe"],"uncaught":false,"x":150,"y":920,"wires":[[]]},{"id":"69806943.4d8f38","type":"debug","z":"89ad9af9.5b24b8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":790,"y":160,"wires":[]},{"id":"c3989524.8b5798","type":"file in","z":"f088168c.08c968","name":"Load stored devices","filename":"/data/devices","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":400,"y":180,"wires":[["d271b67b.a8f8a8"]]},{"id":"682798a.c422868","type":"file","z":"f088168c.08c968","name":"","filename":"/data/devices","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":480,"y":260,"wires":[["c3989524.8b5798"]]},{"id":"be054566.cd3c48","type":"function","z":"f088168c.08c968","name":"","func":"\nmsg.payload = {};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":300,"y":260,"wires":[["682798a.c422868"]]},{"id":"a72de646.787068","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":960,"y":180,"wires":[]},{"id":"630cb3e6.26651c","type":"catch","z":"f088168c.08c968","name":"","scope":["c3989524.8b5798"],"uncaught":false,"x":140,"y":260,"wires":[["be054566.cd3c48"]]},{"id":"31e1623c.3855ce","type":"inject","z":"f088168c.08c968","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":170,"y":180,"wires":[["c3989524.8b5798"]]},{"id":"d271b67b.a8f8a8","type":"json","z":"f088168c.08c968","name":"","property":"payload","action":"","pretty":false,"x":590,"y":180,"wires":[["123f1da3.e864a2"]]},{"id":"123f1da3.e864a2","type":"function","z":"f088168c.08c968","name":"","func":"\nglobal.set('DEVICES', msg.payload);\nmsg.payload = global.get('DEVICES');\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":740,"y":180,"wires":[["a72de646.787068"]]},{"id":"ae6077bf.9d5a38","type":"function","z":"f088168c.08c968","name":"Store devices to file","func":"devices = global.get('DEVICES')\nmsg.payload = devices;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1820,"y":620,"wires":[["a4646f34.c00e9"]]},{"id":"26994d25.5318b2","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2200,"y":620,"wires":[]},{"id":"a4646f34.c00e9","type":"file","z":"f088168c.08c968","name":"","filename":"/data/devices","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":2020,"y":620,"wires":[["26994d25.5318b2"]]},{"id":"4fbe0e0b.34c7a","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":960,"y":320,"wires":[]},{"id":"94ee4274.cd55d","type":"switch","z":"f088168c.08c968","name":"HTTP 200","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":750,"y":340,"wires":[["b6d632f4.66e14"]]},{"id":"79b36c1e.45d4f4","type":"switch","z":"f088168c.08c968","name":"HTTP Error","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":750,"y":400,"wires":[["4fbe0e0b.34c7a","7ec5be33.c9c4c"]]},{"id":"7ec5be33.c9c4c","type":"delay","z":"f088168c.08c968","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":940,"y":400,"wires":[["c3656178.be5c2"]]},{"id":"c3656178.be5c2","type":"link out","z":"f088168c.08c968","name":"","links":["afeab2e2.48ab7"],"x":1085,"y":400,"wires":[]},{"id":"afeab2e2.48ab7","type":"link in","z":"f088168c.08c968","name":"","links":["c3656178.be5c2"],"x":255,"y":380,"wires":[["5bfe6e82.1e21d"]]},{"id":"78e7f8e2.e91838","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":520,"y":420,"wires":[]},{"id":"6340caaf.692834","type":"complete","z":"f088168c.08c968","name":"","scope":["699b7af4.6b49d4"],"uncaught":false,"x":180,"y":680,"wires":[["3b4c58df.91a628"]]},{"id":"da846d5b.8d51b","type":"link out","z":"f088168c.08c968","name":"","links":["86005307.0a5ee"],"x":735,"y":1360,"wires":[]},{"id":"86005307.0a5ee","type":"link in","z":"f088168c.08c968","name":"","links":["da846d5b.8d51b"],"x":1635,"y":580,"wires":[["ae6077bf.9d5a38"]]},{"id":"e7334875.c49738","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":800,"y":1300,"wires":[]},{"id":"31a41763.873b78","type":"function","z":"f088168c.08c968","name":"Store customer data","func":"\nflow.set('CUSTOMERS', msg.payload.data)\n\nmsg.payload = flow.get('CUSTOMERS')\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1020,"y":1900,"wires":[["d92e281f.5a1ef8"]]},{"id":"37d504c7.6a090c","type":"function","z":"f088168c.08c968","name":"Prepare request","func":"\nbase_url = flow.get('URL') + '/api/customer/'\ncustomerId = msg.payload.customerId\ndeviceId = msg.payload.deviceId\n\nmsg.url = base_url + customerId + '/device/' + deviceId\n\nmsg.headers = flow.get('HEADERS')\nreturn msg;\n\n\n\nmsg.payload = {}\n\nreturn msg\nfor (i=0; i<msg.payload.length; i++){\n    customer = msg.payload[i]\n    customerId = customer.id\n    for (j=0; j<customer.devices.length; j++){\n        device = customer.devices[j]\n        deviceId = device_id_map[device.id]\n        request = {}\n        request.url = base_url + customerId + '/device/' + deviceId\n        request.headers = msg.setup.auth_headers\n        request_data.push(request)\n    }\n}\nmsg.payload = request_data\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1090,"y":1260,"wires":[["37ab56e3.28df9a","eb3d9858.d53218"]]},{"id":"37ab56e3.28df9a","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1310,"y":1300,"wires":[]},{"id":"4b7f4f8f.9620b","type":"debug","z":"f088168c.08c968","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":680,"y":1100,"wires":[]},{"id":"948d1f1c.a222f","type":"inject","z":"8f5695d4.26e138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":150,"y":100,"wires":[["4d9cf1c3.82c2c"]]},{"id":"4d9cf1c3.82c2c","type":"function","z":"8f5695d4.26e138","name":"Local setup","func":"flow.set(\"HOSTS\", global.get(\"WOT_HOSTS\"))\nflow.set(\"HEADERS\", {\"Accept\": \"application/json\", 'Content-Type': 'application/json'})\n\nif(!flow.get(\"DEVICES\")){\n    flow.set(\"DEVICES\",{})\n}\nif(!flow.get(\"DATA\")){\n    flow.set(\"DATA\",{})\n}\n//Debug\nmsg.payload = flow.get('HOSTS')\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":100,"wires":[["a6d23aff.e09f38"]]},{"id":"a6d23aff.e09f38","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":560,"y":100,"wires":[]},{"id":"865d5a29.c02858","type":"inject","z":"8f5695d4.26e138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":1540,"wires":[["13cc574d.c46b59"]]},{"id":"13cc574d.c46b59","type":"function","z":"8f5695d4.26e138","name":"Delete local and global device data","func":"\nflow.set(\"DEVICES\",{})\nglobal.set(\"DEVICES\",{})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":550,"y":1540,"wires":[[]]},{"id":"8c01be33.95f17","type":"comment","z":"8f5695d4.26e138","name":"Clear devices [DONT DO THIS]","info":"","x":300,"y":1500,"wires":[]},{"id":"65190813.0d5078","type":"inject","z":"8f5695d4.26e138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":140,"y":1040,"wires":[["cda86cc4.ed919"]]},{"id":"fdec7fb7.7544e","type":"comment","z":"8f5695d4.26e138","name":"Fetch property data","info":"This flow will use the previous fetched devices to pull data values for each property.\n\nThe values will be added to te property objecs as 'value'","x":160,"y":1000,"wires":[]},{"id":"39c00a38.830716","type":"complete","z":"8f5695d4.26e138","name":"","scope":["b5d2850f.6e67c8"],"uncaught":false,"x":140,"y":1260,"wires":[["bcee5caa.56d62"]]},{"id":"cda86cc4.ed919","type":"function","z":"8f5695d4.26e138","name":"Get WoT hosts","func":"msg.payload = flow.get(\"HOSTS\")\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":1040,"wires":[["1c2fc523.0cac6b"]]},{"id":"15bde493.a9a46b","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1100,"y":1180,"wires":[]},{"id":"1c2fc523.0cac6b","type":"split","z":"8f5695d4.26e138","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":540,"y":1040,"wires":[["3bf6b0c3.f4b98"]]},{"id":"3bf6b0c3.f4b98","type":"function","z":"8f5695d4.26e138","name":"Extract device objects","func":"\n\nproperties = []\nall_devices = flow.get('DEVICES')\nkey = msg.payload\n\ndevices = all_devices[key]\nmsg.payload = devices\nmsg.base_url = key\n\nreturn msg\n\nfor (var id in devices) {\n    for (var key in devices[id].properties) {\n        property = devices[id].properties[key]\n        if('links' in property && property.links!=null && property.links.length>0){\n            prop = {};\n            prop.device_id = devices[id].id\n            prop.name = key\n            prop.value = devices[id].properties[key]\n            properties.push(prop)\n        }\n    }\n}\nmsg.payload = properties\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":750,"y":1040,"wires":[["37d81bf4.d9a494","d8dbb417.298a98"]]},{"id":"4ab6440b.f701dc","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1410,"y":1020,"wires":[]},{"id":"b2796283.b171b","type":"split","z":"8f5695d4.26e138","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":880,"y":1120,"wires":[["15bde493.a9a46b","b834355e.dddca8"]]},{"id":"d8dbb417.298a98","type":"function","z":"8f5695d4.26e138","name":"Prepare request","func":"\nmsg.headers=flow.get('HEADERS')\n//base = \"http://\" + flow.get('IP') + \":\" + flow.get('PORT')\nbase = msg.base_url\n\nurl = base + msg.payload.links[0].href\nmsg.obj_id = url+\"-\"+msg.payload.id\nmsg.device_id = msg.payload.id\nmsg.properties = msg.payload.properties\nmsg.classification = msg.payload.classification\n//msg.url = base + msg.payload.value.links[0]\n\nmsg.url = url\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1160,"y":1040,"wires":[["4ab6440b.f701dc","ddd343d2.8cbde"]]},{"id":"ddd343d2.8cbde","type":"http request","z":"8f5695d4.26e138","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1440,"y":1060,"wires":[["55e95a0a.a11bd4","c4f33b9.9a729c8","21890253.5bd7de"]]},{"id":"55e95a0a.a11bd4","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1630,"y":1020,"wires":[]},{"id":"c4f33b9.9a729c8","type":"function","z":"8f5695d4.26e138","name":"Create data object","func":"\ntimestamp = Date.now();\n\nconst milliseconds = 1575909015 * 1000 // 1575909015000\n\nconst dateObject = new Date(timestamp)\n\nconst timestring = dateObject.toLocaleString()\n\ndata_obj = {}\nproperties = msg.properties\n\ndata = msg.payload\nprop_names = keys = Object.keys(data);\n\nvar n = prop_names.length;\nfor (var i = 0; i < n; i++) {\n    name = prop_names[i];\n    value = data[name]\n    properties[name].value = value\n    properties[name].time = timestamp\n    properties[name].timestring = timestring\n}\n\ndata_obj.classification = msg.classification\ndata_obj.id = msg.obj_id\ndata_obj.device_id = msg.device_id\ndata_obj.src = msg.url\ndata_obj.properties = properties\n\nmsg.payload = data_obj\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1680,"y":1060,"wires":[["e047944d.236e98","b5d2850f.6e67c8"]]},{"id":"e047944d.236e98","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1900,"y":1020,"wires":[]},{"id":"b0fe72bd.52bed","type":"inject","z":"8f5695d4.26e138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":560,"y":940,"wires":[["cda86cc4.ed919"]]},{"id":"b5d2850f.6e67c8","type":"function","z":"8f5695d4.26e138","name":"Save data object","func":"MAX = 10000;\n\ndata = flow.get(\"DATA\")\n\nkey = msg.payload.id\n\nif (!(key in data)){\n    data[key]=[]\n}\n\ndata_points = data[key]\ndata_points.push(msg.payload)\n\nif (data_points.length>MAX){\n    data_points = data_points.slice(data_points.length-MAX)\n}\n\ndata[key] = data_points\nflow.set(\"DATA\",data)\n\nmsg.payload = flow.get(\"DATA\")\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1910,"y":1060,"wires":[["95ec485f.b0e3c8"]]},{"id":"95ec485f.b0e3c8","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2170,"y":1020,"wires":[]},{"id":"bcee5caa.56d62","type":"function","z":"8f5695d4.26e138","name":"Store data in file","func":"data = flow.get('DATA')\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":1340,"wires":[["89ee51ff.b1b17"]]},{"id":"ca9df9bb.6f8a08","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":770,"y":1340,"wires":[]},{"id":"89ee51ff.b1b17","type":"file","z":"8f5695d4.26e138","name":"","filename":"/data/data_file","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":590,"y":1340,"wires":[["ca9df9bb.6f8a08"]]},{"id":"b7aeefea.031d7","type":"inject","z":"8f5695d4.26e138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":1340,"wires":[["bcee5caa.56d62"]]},{"id":"b5e61f2f.f8fef","type":"file in","z":"8f5695d4.26e138","name":"Load stored devices","filename":"/data/data_file","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":370,"y":1420,"wires":[["37eed0f2.f5f4"]]},{"id":"da93a533.e384f8","type":"debug","z":"8f5695d4.26e138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":930,"y":1420,"wires":[]},{"id":"946ba3f6.a7f12","type":"inject","z":"8f5695d4.26e138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":140,"y":1420,"wires":[["b5e61f2f.f8fef"]]},{"id":"37eed0f2.f5f4","type":"json","z":"8f5695d4.26e138","name":"","property":"payload","action":"","pretty":false,"x":560,"y":1420,"wires":[["22021503.ec6d7a"]]},{"id":"22021503.ec6d7a","type":"function","z":"8f5695d4.26e138","name":"","func":"\nglobal.set('DATA', msg.payload);\nmsg.payload = global.get('DATA');\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":710,"y":1420,"wires":[["da93a533.e384f8"]]},{"id":"3053ab1f.31b654","type":"comment","z":"8f5695d4.26e138","name":"Load stored data","info":"","x":140,"y":1380,"wires":[]},{"id":"ad281267.32e3b","type":"comment","z":"8f5695d4.26e138","name":"Store data in file","info":"","x":150,"y":1300,"wires":[]},{"id":"66588323.9b24fc","type":"http in","z":"e7ae0c3a.b2112","name":"","url":"/hello","method":"get","upload":false,"swaggerDoc":"","x":170,"y":220,"wires":[["72e56ab7.fb2094","6d111fac.d11de"]]},{"id":"72e56ab7.fb2094","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":410,"y":300,"wires":[]},{"id":"a9b5fa9c.7d34a8","type":"http response","z":"e7ae0c3a.b2112","name":"","statusCode":"","headers":{},"x":530,"y":220,"wires":[]},{"id":"6d111fac.d11de","type":"function","z":"e7ae0c3a.b2112","name":"","func":"\nmsg.payload = \"World!\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":220,"wires":[["a9b5fa9c.7d34a8"]]},{"id":"75d0e431.69eaec","type":"http in","z":"e7ae0c3a.b2112","name":"","url":"/data/pulse","method":"get","upload":false,"swaggerDoc":"","x":190,"y":420,"wires":[["3d7db2d1.cd99de","785f3c19.3c4784"]]},{"id":"3d7db2d1.cd99de","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":630,"y":520,"wires":[]},{"id":"2c91fcc9.4c8ae4","type":"http response","z":"e7ae0c3a.b2112","name":"","statusCode":"","headers":{},"x":1150,"y":420,"wires":[]},{"id":"fc6405db.142268","type":"function","z":"e7ae0c3a.b2112","name":"Filter data","func":"\nobj_keys = Object.keys(msg.payload);\nuser = msg.param.user\n\nfunction verifyClassification(classification, user){\n    owners = Object.keys(classification)\n    for (k=0; k<owners.length; k++){\n        owner = owners[k];\n        readers = classification[owner];\n        // User needs to be included in all policies\n        // in the classification to be allowed to read\n        // the data\n        if(user!=owner && !readers.includes(user)){\n            return false;\n        }\n    }\n    return true;\n}\n\ndata = []\nfor(i=0; i<obj_keys.length; i++){\n    key = obj_keys[i]\n    obj = msg.payload[key]\n    //node.warn(\"Key:\" + key)\n    for (j=0; j<obj.length; j++){\n        data_point = obj[j]\n        classification = data_point.classification\n        if(verifyClassification(classification, user)){\n            if('pulse' in data_point.properties){\n                return_obj = data_point.properties.pulse\n                return_obj.device_id = data_point.device_id\n                data.push(return_obj)\n            }\n            //data.push(data_point.properties)   \n        }\n    }\n    //node.warn(\"i=\" + i)\n}\n\nif (\"limit\" in msg.param){\n    N = parseInt(msg.param.limit)\n    data = data.slice(data.length-1-N)\n}\n\nmsg.data = data\nmsg.payload = data\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":990,"y":420,"wires":[["2c91fcc9.4c8ae4","80612a96.9666c8"]]},{"id":"9a7008e3.baebd8","type":"file in","z":"e7ae0c3a.b2112","name":"Load stored devices","filename":"/data/data_file","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":630,"y":420,"wires":[["6b5ae27c.9cfe6c"]]},{"id":"6b5ae27c.9cfe6c","type":"json","z":"e7ae0c3a.b2112","name":"","property":"payload","action":"","pretty":false,"x":820,"y":420,"wires":[["fc6405db.142268","9002cf19.f4571"]]},{"id":"80612a96.9666c8","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1190,"y":500,"wires":[]},{"id":"785f3c19.3c4784","type":"function","z":"e7ae0c3a.b2112","name":"Extract params","func":"\n//msg.user = msg.payload.user\nmsg.param = msg.payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":420,"wires":[["9a7008e3.baebd8","3d7db2d1.cd99de"]]},{"id":"a327cbda.5b2e58","type":"function","z":"e7ae0c3a.b2112","name":"Mock request","func":"msg.payload = {}\nmsg.payload.user = 'patient'\nmsg.payload.limit = '5'\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":480,"wires":[["785f3c19.3c4784"]]},{"id":"cc6e5de3.f79b5","type":"inject","z":"e7ae0c3a.b2112","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":480,"wires":[["a327cbda.5b2e58"]]},{"id":"9002cf19.f4571","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":950,"y":520,"wires":[]},{"id":"d213becb.31788","type":"file in","z":"d111d806.aa47b8","name":"Load stored devices","filename":"/data/data_file","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":380,"y":220,"wires":[["7782097d.9a0cf8"]]},{"id":"8abdfb.977bc208","type":"inject","z":"d111d806.aa47b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":280,"wires":[["3b4f6abb.3aac06"]]},{"id":"dcc700dc.91df9","type":"debug","z":"d111d806.aa47b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1170,"y":280,"wires":[]},{"id":"7782097d.9a0cf8","type":"json","z":"d111d806.aa47b8","name":"","property":"payload","action":"","pretty":false,"x":550,"y":220,"wires":[["b5dcc52a.a8a2a8"]]},{"id":"3b4f6abb.3aac06","type":"function","z":"d111d806.aa47b8","name":"Extract data PatientA","func":"\nmsg.readers = [\"PatientA\"]\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":280,"wires":[["b5dcc52a.a8a2a8"]]},{"id":"b5dcc52a.a8a2a8","type":"merge","z":"d111d806.aa47b8","name":"","timeout":"1","x":710,"y":280,"wires":[["49d777a7.79f528"]]},{"id":"23da2fda.7b5b2","type":"complete","z":"d111d806.aa47b8","name":"","scope":["3b4f6abb.3aac06","51840584.f1339c","7da61364.e6481c","27a6fce.c9b7104"],"uncaught":false,"x":190,"y":220,"wires":[["d213becb.31788"]]},{"id":"49d777a7.79f528","type":"function","z":"d111d806.aa47b8","name":"Format data","func":"\ndata = msg.payload\nif ('readers' in data[0]){\n    readers = data[0].readers\n    payload = data[1].payload\n} else{\n    readers = data[1].readers\n    payload = data[0].payload\n}\n\nmsg.payload = payload\nmsg.readers = readers\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":280,"wires":[["cc3c8b15.9a1208"]]},{"id":"cc3c8b15.9a1208","type":"function","z":"d111d806.aa47b8","name":"Filter data","func":"\n\nreaders = msg.readers\n\nfunction canRead(classification, user){\n    owners = Object.keys(classification)\n    for (k=0; k<owners.length; k++){\n        owner = owners[k];\n        readers = classification[owner];\n        // User needs to be included in all policies\n        // in the classification to be allowed to read\n        // the data\n        if(user!=owner && !readers.includes(user)){\n            return false;\n        }\n    }\n    return true;\n}\n\nfunction canAnyRead(classification, users){\n    for (ii=0; ii<users.length; ii++){\n        if(canRead(classification, users[ii])){\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction filterData(data, users){\n    obj_keys = Object.keys(data);\n    new_data = {}\n    for(i=0; i<obj_keys.length; i++){\n        filtered_data = [] \n        key = obj_keys[i]\n        obj = data[key]\n        //node.warn(\"Key:\" + key)\n        for (j=0; j<obj.length; j++){\n            data_point = obj[j]\n            classification = data_point.classification\n            if(canAnyRead(classification, users)){\n                //return_obj = data_point.properties.pulse\n                //return_obj.device_id = data_point.device_id\n                filtered_data.push(data_point)\n                //data.push(data_point.properties)   \n            }\n        }\n        new_data[key]=filtered_data\n    //node.warn(\"i=\" + i)\n    }\n    return new_data\n}\n\ndata = filterData(msg.payload, readers)\n\n\nmsg.data = data\nmsg.payload = data\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1020,"y":280,"wires":[["dcc700dc.91df9"]]},{"id":"a06d2585.1daef8","type":"inject","z":"d111d806.aa47b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":360,"wires":[["51840584.f1339c"]]},{"id":"51840584.f1339c","type":"function","z":"d111d806.aa47b8","name":"Extract data PatientB","func":"\nmsg.readers = [\"PatientB\"]\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":360,"wires":[["b5dcc52a.a8a2a8"]]},{"id":"18f39347.fc491d","type":"inject","z":"d111d806.aa47b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":440,"wires":[["7da61364.e6481c"]]},{"id":"7da61364.e6481c","type":"function","z":"d111d806.aa47b8","name":"Extract data Doctors","func":"\nmsg.readers = [\"Doctors\"]\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":440,"wires":[["b5dcc52a.a8a2a8"]]},{"id":"2ec9925a.54320e","type":"inject","z":"d111d806.aa47b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":520,"wires":[["27a6fce.c9b7104"]]},{"id":"27a6fce.c9b7104","type":"function","z":"d111d806.aa47b8","name":"Extract data Doctors and PatientC","func":"\nmsg.readers = [\"Doctors\", \"PatientC\"]\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":520,"wires":[["b5dcc52a.a8a2a8"]]},{"id":"23a07893.f3af78","type":"file in","z":"d111d806.aa47b8","name":"Load stored devices","filename":"/data/data_file","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":640,"y":740,"wires":[["8f70a808.d4d708"]]},{"id":"93cdf522.6bf128","type":"inject","z":"d111d806.aa47b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":180,"y":740,"wires":[["708961cf.7ce93"]]},{"id":"188f3b52.ad4ea5","type":"debug","z":"d111d806.aa47b8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":630,"y":860,"wires":[]},{"id":"8f70a808.d4d708","type":"json","z":"d111d806.aa47b8","name":"","property":"payload","action":"","pretty":false,"x":810,"y":740,"wires":[["d1043ba3.c60368"]]},{"id":"708961cf.7ce93","type":"function","z":"d111d806.aa47b8","name":"Extract data PatientA","func":"\nmsg.readers = [\"PatientA\"]\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":740,"wires":[["23a07893.f3af78"]]},{"id":"d1043ba3.c60368","type":"function","z":"d111d806.aa47b8","name":"Filter data","func":"\n\nreaders = msg.readers\n\nfunction canRead(classification, user){\n    owners = Object.keys(classification)\n    for (k=0; k<owners.length; k++){\n        owner = owners[k];\n        readers = classification[owner];\n        // User needs to be included in all policies\n        // in the classification to be allowed to read\n        // the data\n        if(user!=owner && !readers.includes(user)){\n            return false;\n        }\n    }\n    return true;\n}\n\nfunction canAnyRead(classification, users){\n    for (ii=0; ii<users.length; ii++){\n        if(canRead(classification, users[ii])){\n            return true;\n        }\n    }\n    return false;\n}\n\nfunction filterData(data, users){\n    obj_keys = Object.keys(data);\n    new_data = {}\n    for(i=0; i<obj_keys.length; i++){\n        filtered_data = [] \n        key = obj_keys[i]\n        obj = data[key]\n        //node.warn(\"Key:\" + key)\n        for (j=0; j<obj.length; j++){\n            data_point = obj[j]\n            classification = data_point.classification\n            if(canAnyRead(classification, users)){\n                filtered_data.push(data_point)\n            }\n        }\n        if (filtered_data.length>0){\n            new_data[key]=filtered_data    \n        }\n    //node.warn(\"i=\" + i)\n    }\n    return new_data\n}\n\ndata = filterData(msg.payload, readers)\n\n\n//msg.data = data\nmsg.payload = data\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":960,"y":740,"wires":[["3e1c5314.eedabc"]]},{"id":"3e1c5314.eedabc","type":"function","z":"d111d806.aa47b8","name":"Extract pulse data","func":"\nendpoints = owners = Object.keys(msg.payload)\n\ndata = []\nfor (i=0; i<endpoints.length; i++){\n    data_list = msg.payload[endpoints[i]]\n    for (j=0; j<data_list.length; j++){\n        if('pulse' in data_list[j].properties){\n            pulse_obj = {}\n            pulse_obj.classification = data_list[j].classification\n            pulse_data = data_list[j].properties.pulse\n            pulse_obj.value = pulse_data.value\n            pulse_obj.time = pulse_data.time\n            pulse_obj.timestring = pulse_data.timestring\n            data.push(pulse_obj);   \n        }\n    }\n}\n\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":820,"wires":[["188f3b52.ad4ea5","e7139ca4.f995e"]]},{"id":"e7139ca4.f995e","type":"function","z":"d111d806.aa47b8","name":"Compute mean value per hour","func":"\n\ndata_list = msg.payload\n\nfunction as2DigitString(digit){\n    if (digit<10){\n        return \"0\"+digit;\n    }\n    return \"\"+digit;\n}\n\nfunction getMonth(date){\n    month = date.getMonth()+1;\n    return as2DigitString(month);\n}\n\nfunction getDay(date){\n    day = date.getDate();\n    return as2DigitString(day);\n}\n\nfunction getHour(date){\n    hour = date.getHours()+1;\n    return as2DigitString(hour);\n}\n\nfunction getTimeKey(timestamp){\n    var date = new Date(timestamp);\n    year = date.getFullYear();\n    //month = date.getMonth()+1;\n    //day = date.getDate();\n    //hour = date.getHours()+1;\n    month = getMonth(date);\n    day = getDay(date);\n    hour = getHour(date);\n    \n    //2011-10-10T14:48:00\n    timeString = year+\"-\"+month+\"-\"+day+\"T\"+hour+\":00:00\";\n    key = Date.parse(timeString)\n    //node.warn(\"Timestring:\" + timeString)\n    //node.warn(\"Timestamp:\" + key)\n    \n    return key;\n}\nfunction mergeLists(l1,l2){\n    list = l1.concat(l2);\n    var unique = new Set(list);\n    return Array.from(unique);\n}\nfunction appendClassification(c1,c2){\n    const owners = Object.keys(c2);\n    for (j=0; j<owners.length; j++){\n        owner = owners[j];\n        \n        if (!(owner in c1)){\n            c1[owner] = c2[owner];\n        }else{\n            r1 = c1[owner]\n            r2 = c2[owner]\n            readers = mergeLists(r1,r2);\n            c1[owner] = readers;\n        }\n    }\n    return c1;\n}\nsum_dict = {};\nn_dict = {};\nmean_dict = {};\nresult = []\nfor(i=0; i<data_list.length; i++){\n    timestamp = data_list[i].time\n    value = data_list[i].value\n    key = getTimeKey(timestamp)\n    if (!(key in mean_dict)){\n        //sum_dict[key] = sum_dict[key]+\n        mean_obj = {}\n        mean_obj['classification'] = {}\n        mean_obj['values'] = [];\n        mean_dict[key] = mean_obj;\n    }\n    //node.warn(\"Append value:\" + key + \" \" + value)\n    mean_dict[key].values.push(value);\n    c1 = mean_dict[key].classification;\n    c2 = data_list[i].classification;\n    classification = appendClassification(c1,c2);\n    mean_dict[key].classification = classification;\n    //result.push(key)\n}\n\nfunction computeAverage(arr){\n    if (arr.length==0){\n        return 0;\n    }\n    //Find the sum\n    var sum = 0;\n    for(i=0; i<arr.length; i++) {\n        sum += arr[i];\n    }\n    return (sum / arr.length);\n}\n\nkeys = Object.keys(mean_dict);\nmean = [];\nfor (k=0; k<keys.length; k++){\n    obj = {}\n    values = mean_dict[keys[k]].values;\n    obj.time = parseInt(keys[k], 10);\n    obj.value = computeAverage(values);\n    obj.classification = mean_dict[key].classification;\n    mean.push(obj);\n}\ndata = {}\ndata.id = \"mean-value-hour-\"+msg.readers\ndata.mean = mean;\nmsg.payload = data;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":810,"y":820,"wires":[["8e0ed44c.c43538","57542735.590958"]]},{"id":"8e0ed44c.c43538","type":"debug","z":"d111d806.aa47b8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1050,"y":820,"wires":[]},{"id":"7ea32f8d.53294","type":"file in","z":"d111d806.aa47b8","name":"Load stored devices","filename":"/data/mean_data","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":380,"y":1100,"wires":[["9332b850.601ad8"]]},{"id":"a5416978.014968","type":"debug","z":"d111d806.aa47b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1130,"y":1100,"wires":[]},{"id":"118a2d95.be8332","type":"inject","z":"d111d806.aa47b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":150,"y":1100,"wires":[["7ea32f8d.53294"]]},{"id":"9332b850.601ad8","type":"json","z":"d111d806.aa47b8","name":"","property":"payload","action":"","pretty":false,"x":570,"y":1100,"wires":[["1a778b32.844795"]]},{"id":"1a778b32.844795","type":"function","z":"d111d806.aa47b8","name":"Apply Research Project Declassification Policy","func":"\nall_data = msg.payload;\n\nkeys = Object.keys(all_data);\n\nfor (i=0; i<keys.length; i++){\n    data = all_data[keys[i]]\n    \n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":840,"y":1100,"wires":[["a5416978.014968"]]},{"id":"31bf4972.c2be06","type":"comment","z":"d111d806.aa47b8","name":"Declassify mean data","info":"","x":170,"y":1060,"wires":[]},{"id":"b2fdcb69.68edd8","type":"inject","z":"d111d806.aa47b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":1200,"wires":[["9c5f0da1.2e364"]]},{"id":"9c5f0da1.2e364","type":"function","z":"d111d806.aa47b8","name":"Extract mean data PatientA","func":"\nmsg.readers = [\"PatientA\"]\n\nDEVICE = \"mean-value-hour-PatientA\"\ndata = global.get(\"HOSPITAL_MEAN\")[DEVICE]\n\nmsg.payload = {}\nmsg.payload.device = DEVICE\nmsg.payload.data = data\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":1200,"wires":[["74bf5fef.b5811","a05ec5d1.86d158"]]},{"id":"a05ec5d1.86d158","type":"function","z":"d111d806.aa47b8","name":"Apply Research Project Declassification Policy","func":"\nall_data = msg.payload;\n\nfunction isOwnerPatientA(owner, readers){\n    if (owner == \"PatientA\"){\n        return true;\n    }\n    return false;\n}\n\nfunction getResearchProjectPolicy(){\n    owner = \"ResearchProject\",\n    readers = [owner]\n    label = {}\n    label[owner] = readers\n    return label;\n}\n\ndeclassificationPolicy = {\n    requirement:isOwnerPatientA,\n    replacement:getResearchProjectPolicy()\n}\n\nfunction declassifyLabel(label, declassPol){\n    label_copy = Object.assign({}, label);\n    owners = Object.keys(label_copy);\n    for (j=0; j<owners.length; j++){\n        readers = label_copy[owners[j]]\n        if (declassPol.requirement(owners[j], readers)){\n            newPol = declassPol.replacement\n            delete label_copy[owners[j]];\n            label_copy = Object.assign({}, label_copy, newPol);\n        }\n    }\n    return label_copy;\n}\n\nfunction declassifyData(data, declassPol){\n    requirement = declassPol.requirement\n    newPolicy = declassPol.replacement\n    for(i=0; i<data.length; i++){\n        label = data[i].classification;\n        new_label = declassifyLabel(label, declassPol);\n        data[i].classification = new_label\n    }\n    return data;\n}\n\ndata = msg.payload.data\ndeclassified_data = declassifyData(data, declassificationPolicy)\nid = msg.payload.device + '-declassified'\n\nmsg.payload = {};\nmsg.payload.data = declassified_data;\nmsg.payload.id = id;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":760,"y":1200,"wires":[["291b37f.62cdcc8","d9d282b7.654b8"]]},{"id":"291b37f.62cdcc8","type":"debug","z":"d111d806.aa47b8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1070,"y":1260,"wires":[]},{"id":"1aa6b415.a30ddc","type":"comment","z":"d111d806.aa47b8","name":"Compute mean data PatientA","info":"","x":220,"y":700,"wires":[]},{"id":"57542735.590958","type":"function","z":"d111d806.aa47b8","name":"Store in global scope","func":"\ndata = msg.payload\n\nmean_data = global.get(\"HOSPITAL_MEAN\")\nmean_data[data.id] = data.mean\nglobal.set(\"HOSPITAL_MEAN\",mean_data)\n\nmsg.payload = global.get(\"HOSPITAL_MEAN\");\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1080,"y":960,"wires":[["ce562309.1c873"]]},{"id":"ce562309.1c873","type":"debug","z":"d111d806.aa47b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1270,"y":960,"wires":[]},{"id":"74bf5fef.b5811","type":"debug","z":"d111d806.aa47b8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":610,"y":1260,"wires":[]},{"id":"3efbdc38.bd1d74","type":"complete","z":"d111d806.aa47b8","name":"","scope":["57542735.590958"],"uncaught":false,"x":130,"y":1240,"wires":[["9c5f0da1.2e364"]]},{"id":"d9d282b7.654b8","type":"function","z":"d111d806.aa47b8","name":"Store in global scope","func":"\ndata = msg.payload.data\nid = msg.payload.id\n\nmean_data = global.get(\"HOSPITAL_MEAN\")\nmean_data[id] = data\nglobal.set(\"HOSPITAL_MEAN\",mean_data)\n\nmsg.payload = global.get(\"HOSPITAL_MEAN\");\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1080,"y":1200,"wires":[["c6f6802b.c3265"]]},{"id":"c6f6802b.c3265","type":"debug","z":"d111d806.aa47b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1270,"y":1200,"wires":[]},{"id":"392e5a06.906ae6","type":"http in","z":"e7ae0c3a.b2112","name":"","url":"/data/mean","method":"get","upload":false,"swaggerDoc":"","x":180,"y":660,"wires":[["6c38df66.aada","e831e148.192cf"]]},{"id":"6c38df66.aada","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":620,"y":760,"wires":[]},{"id":"c3d90d2d.db6ca","type":"http response","z":"e7ae0c3a.b2112","name":"","statusCode":"","headers":{},"x":1140,"y":660,"wires":[]},{"id":"1a73ed6c.0a5dd3","type":"function","z":"e7ae0c3a.b2112","name":"Filter data","func":"\nobj_keys = Object.keys(msg.payload);\nuser = msg.param.user\n\nfunction verifyClassification(classification, user){\n    owners = Object.keys(classification)\n    for (k=0; k<owners.length; k++){\n        owner = owners[k];\n        readers = classification[owner];\n        // User needs to be included in all policies\n        // in the classification to be allowed to read\n        // the data\n        if(user!=owner && !readers.includes(user)){\n            return false;\n        }\n    }\n    return true;\n}\n\ndata = []\nfor (j=0; j<msg.payload.length; j++){\n    data_point = msg.payload[j]\n    classification = data_point.classification\n    if(verifyClassification(classification, user)){\n        return_obj = {}\n        return_obj.time = data_point.time\n        return_obj.value = data_point.value\n        data.push(return_obj)\n    }\n}\n    //node.warn(\"i=\" + i)\n\nif (\"limit\" in msg.param){\n    N = parseInt(msg.param.limit)\n    data = data.slice(data.length-1-N)\n}\n\nmsg.data = data\nmsg.payload = data\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":660,"wires":[["c3d90d2d.db6ca","439d976.f798468"]]},{"id":"439d976.f798468","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1180,"y":740,"wires":[]},{"id":"e831e148.192cf","type":"function","z":"e7ae0c3a.b2112","name":"Extract params","func":"\n//msg.user = msg.payload.user\nmsg.param = msg.payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":660,"wires":[["6c38df66.aada","92c17309.225b4"]]},{"id":"bce174a2.1593c8","type":"function","z":"e7ae0c3a.b2112","name":"Mock request","func":"msg.payload = {}\nmsg.payload.user = 'ResearchProject'\nmsg.payload.device = \"mean-value-hour-PatientA-declassified\"\nmsg.payload.limit = '5'\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":200,"y":720,"wires":[["e831e148.192cf"]]},{"id":"f89c2f58.a085b","type":"inject","z":"e7ae0c3a.b2112","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":800,"wires":[["bce174a2.1593c8"]]},{"id":"5d1fe833.6803a8","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":940,"y":760,"wires":[]},{"id":"92c17309.225b4","type":"function","z":"e7ae0c3a.b2112","name":"Fetch mean data from device","func":"\ndevice = msg.payload.device\ndata = global.get(\"HOSPITAL_MEAN\")[device];\n\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":700,"y":660,"wires":[["1a73ed6c.0a5dd3","5d1fe833.6803a8"]]},{"id":"867f46c8.0e7998","type":"complete","z":"8f5695d4.26e138","d":true,"name":"","scope":["4d9cf1c3.82c2c"],"uncaught":false,"x":140,"y":1460,"wires":[["b5e61f2f.f8fef"]]},{"id":"61f8814c.32224","type":"inject","z":"9c1e076.5f7d4f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":270,"y":80,"wires":[["b07c633f.07e46"]]},{"id":"b07c633f.07e46","type":"function","z":"9c1e076.5f7d4f8","name":"Local setup","func":"flow.set(\"HOSTS\", global.get(\"TAXI_WOT_HOSTS\"))\nflow.set(\"HEADERS\", {\"Accept\": \"application/json\", 'Content-Type': 'application/json'})\n\nif(!flow.get(\"DEVICES\")){\n    flow.set(\"DEVICES\",{})\n}\nif(!flow.get(\"DATA\")){\n    flow.set(\"DATA\",{})\n}\n//Debug\nmsg.payload = flow.get('HOSTS')\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":80,"wires":[["4301dd25.c7ad94"]]},{"id":"4301dd25.c7ad94","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":680,"y":80,"wires":[]},{"id":"f6e4963f.0baba8","type":"function","z":"9c1e076.5f7d4f8","name":"Prepare request","func":"msg.headers=flow.get('HEADERS')\nmsg.url = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":660,"y":240,"wires":[["1e51977d.cea649","6c977a8f.720674"]]},{"id":"1d941820.395368","type":"inject","z":"9c1e076.5f7d4f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":110,"y":240,"wires":[["cab18742.f59798"]]},{"id":"bdb3a4ad.c90ab8","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1310,"y":240,"wires":[]},{"id":"1e51977d.cea649","type":"http request","z":"9c1e076.5f7d4f8","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":870,"y":240,"wires":[["cb6cc2c.7a1604","5e1afdfc.9324b4"]]},{"id":"5e1afdfc.9324b4","type":"function","z":"9c1e076.5f7d4f8","name":"Update devices","func":"\nall_devices = flow.get('DEVICES')\nkey = msg.url\ndevices = msg.payload\nall_devices[key]=devices\n\nflow.set('DEVICES', all_devices)\n\n// Debug\nmsg.payload = flow.get('DEVICES')\nreturn msg\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1100,"y":240,"wires":[["bdb3a4ad.c90ab8"]]},{"id":"75e2dc6b.dd4ad4","type":"comment","z":"9c1e076.5f7d4f8","name":"Fetch devices","info":"This flow requst device data from the web of things endpoint.\n\nNote that all device data will be replaced and hence the data value will be missing","x":100,"y":200,"wires":[]},{"id":"6c977a8f.720674","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":860,"y":280,"wires":[]},{"id":"cb6cc2c.7a1604","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1060,"y":280,"wires":[]},{"id":"67675a0f.265214","type":"split","z":"9c1e076.5f7d4f8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"url","x":480,"y":240,"wires":[["f6e4963f.0baba8"]]},{"id":"cab18742.f59798","type":"function","z":"9c1e076.5f7d4f8","name":"Get WoT hosts","func":"msg.payload = flow.get(\"HOSTS\")\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":310,"y":240,"wires":[["67675a0f.265214"]]},{"id":"c55ae68d.777868","type":"inject","z":"9c1e076.5f7d4f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":100,"y":420,"wires":[["ce4d4248.13d55"]]},{"id":"28e6c353.a15e1c","type":"comment","z":"9c1e076.5f7d4f8","name":"Fetch property data","info":"This flow will use the previous fetched devices to pull data values for each property.\n\nThe values will be added to te property objecs as 'value'","x":120,"y":380,"wires":[]},{"id":"ce4d4248.13d55","type":"function","z":"9c1e076.5f7d4f8","name":"Get WoT hosts","func":"msg.payload = flow.get(\"HOSTS\")\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":420,"wires":[["18fb91b2.2d907e"]]},{"id":"e15f5d2.6df94a","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1080,"y":360,"wires":[]},{"id":"18fb91b2.2d907e","type":"split","z":"9c1e076.5f7d4f8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":500,"y":420,"wires":[["761a18c2.72d588"]]},{"id":"761a18c2.72d588","type":"function","z":"9c1e076.5f7d4f8","name":"Extract device objects","func":"\n\nproperties = []\nall_devices = flow.get('DEVICES')\nkey = msg.payload\n\ndevices = all_devices[key]\nmsg.payload = devices\nmsg.base_url = key\n\nreturn msg\n\nfor (var id in devices) {\n    for (var key in devices[id].properties) {\n        property = devices[id].properties[key]\n        if('links' in property && property.links!=null && property.links.length>0){\n            prop = {};\n            prop.device_id = devices[id].id\n            prop.name = key\n            prop.value = devices[id].properties[key]\n            properties.push(prop)\n        }\n    }\n}\nmsg.payload = properties\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":420,"wires":[["be8f0ba1.1edc68"]]},{"id":"be8f0ba1.1edc68","type":"split","z":"9c1e076.5f7d4f8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":920,"y":420,"wires":[["43ce1517.72f60c","e15f5d2.6df94a"]]},{"id":"43ce1517.72f60c","type":"function","z":"9c1e076.5f7d4f8","name":"Prepare request","func":"\nmsg.headers=flow.get('HEADERS')\n//base = \"http://\" + flow.get('IP') + \":\" + flow.get('PORT')\nbase = msg.base_url\n\nurl = base + msg.payload.links[0].href\nmsg.obj_id = url+\"-\"+msg.payload.id\nmsg.device_id = msg.payload.id\nmsg.properties = msg.payload.properties\nmsg.classification = msg.payload.classification\n//msg.url = base + msg.payload.value.links[0]\n\nmsg.url = url\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1120,"y":420,"wires":[["93928bae.07b878"]]},{"id":"93928bae.07b878","type":"http request","z":"9c1e076.5f7d4f8","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":580,"y":520,"wires":[["50aee8b3.94f6a8","fb20d9a.0c6c028"]]},{"id":"50aee8b3.94f6a8","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":790,"y":620,"wires":[]},{"id":"fb20d9a.0c6c028","type":"function","z":"9c1e076.5f7d4f8","name":"Create data object","func":"\ntimestamp = Date.now();\n\nconst milliseconds = 1575909015 * 1000 // 1575909015000\n\nconst dateObject = new Date(timestamp)\n\nconst timestring = dateObject.toLocaleString()\n\ndata_obj = {}\nproperties = msg.properties\n\ndata = msg.payload\nprop_names = keys = Object.keys(data);\n\nvar n = prop_names.length;\nfor (var i = 0; i < n; i++) {\n    name = prop_names[i];\n    value = data[name]\n    properties[name].value = value\n    properties[name].time = timestamp\n    properties[name].timestring = timestring\n}\n\ndata_obj.classification = msg.classification\ndata_obj.id = msg.obj_id\ndata_obj.device_id = msg.device_id\ndata_obj.src = msg.url\ndata_obj.properties = properties\n\nmsg.payload = data_obj\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":520,"wires":[["fa66bf4a.fa851","903c64cc.411d28"]]},{"id":"fa66bf4a.fa851","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1040,"y":480,"wires":[]},{"id":"903c64cc.411d28","type":"function","z":"9c1e076.5f7d4f8","name":"Save data object","func":"MAX = 10000;\n\ndata = flow.get(\"DATA\")\n\nkey = msg.payload.id\n\nif (!(key in data)){\n    data[key]=[]\n}\n\ndata_points = data[key]\ndata_points.push(msg.payload)\n\nif (data_points.length>MAX){\n    data_points = data_points.slice(data_points.length-MAX)\n}\n\ndata[key] = data_points\nflow.set(\"DATA\",data)\n\nmsg.payload = flow.get(\"DATA\")\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":520,"wires":[["f9549926.239ab8"]]},{"id":"f9549926.239ab8","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1310,"y":480,"wires":[]},{"id":"9b6edaa7.cbd708","type":"complete","z":"9c1e076.5f7d4f8","name":"","scope":["903c64cc.411d28"],"uncaught":false,"x":110,"y":660,"wires":[["ea0154b0.fa5438"]]},{"id":"ea0154b0.fa5438","type":"function","z":"9c1e076.5f7d4f8","name":"Store data in file","func":"data = flow.get('DATA')\nmsg.payload = data;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":740,"wires":[["c8ef3021.54852"]]},{"id":"3260b286.eba77e","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":740,"y":740,"wires":[]},{"id":"c8ef3021.54852","type":"file","z":"9c1e076.5f7d4f8","name":"","filename":"/data/taxi_data_file","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":570,"y":740,"wires":[["3260b286.eba77e"]]},{"id":"52a89350.fc306c","type":"inject","z":"9c1e076.5f7d4f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":110,"y":740,"wires":[["ea0154b0.fa5438"]]},{"id":"1908fb07.852185","type":"comment","z":"9c1e076.5f7d4f8","name":"Store data in file","info":"","x":120,"y":700,"wires":[]},{"id":"3044816b.df090e","type":"file in","z":"9c1e076.5f7d4f8","name":"Load stored devices","filename":"/data/taxi_data_file","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":340,"y":860,"wires":[["2c3e81a9.7578fe"]]},{"id":"8e6e35d1.a08878","type":"debug","z":"9c1e076.5f7d4f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":900,"y":860,"wires":[]},{"id":"76001390.dff01c","type":"inject","z":"9c1e076.5f7d4f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":110,"y":860,"wires":[["3044816b.df090e"]]},{"id":"2c3e81a9.7578fe","type":"json","z":"9c1e076.5f7d4f8","name":"","property":"payload","action":"","pretty":false,"x":530,"y":860,"wires":[["ad9e47ef.945338"]]},{"id":"ad9e47ef.945338","type":"function","z":"9c1e076.5f7d4f8","name":"","func":"\nglobal.set('DATA', msg.payload);\nmsg.payload = global.get('DATA');\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":860,"wires":[["8e6e35d1.a08878"]]},{"id":"b9eec270.e29ad","type":"comment","z":"9c1e076.5f7d4f8","name":"Load stored data","info":"","x":110,"y":820,"wires":[]},{"id":"cc7689b0.3f95e8","type":"complete","z":"9c1e076.5f7d4f8","name":"","scope":["b07c633f.07e46"],"uncaught":false,"x":110,"y":900,"wires":[["3044816b.df090e"]]},{"id":"bf48430c.6bc1d","type":"inject","z":"9c1e076.5f7d4f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":1080,"wires":[["a7ddf5a0.774938"]]},{"id":"a7ddf5a0.774938","type":"function","z":"9c1e076.5f7d4f8","name":"Delete local device data","func":"\nflow.set(\"DEVICES\",{})\n//global.set(\"DEVICES\",{})\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":1080,"wires":[[]]},{"id":"8fc2e12f.1ef4e","type":"comment","z":"9c1e076.5f7d4f8","name":"Clear devices [DONT DO THIS]","info":"","x":240,"y":1040,"wires":[]},{"id":"ea980516.08c4e8","type":"http in","z":"a36580c0.b9cfc","name":"","url":"/taxi_data/position","method":"get","upload":false,"swaggerDoc":"","x":120,"y":160,"wires":[["c7e2a410.3b78a8","b99bbdda.7e021"]]},{"id":"c7e2a410.3b78a8","type":"debug","z":"a36580c0.b9cfc","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":580,"y":260,"wires":[]},{"id":"6a918290.6bd87c","type":"http response","z":"a36580c0.b9cfc","name":"","statusCode":"","headers":{},"x":1100,"y":160,"wires":[]},{"id":"565297f6.ed7cf8","type":"function","z":"a36580c0.b9cfc","name":"Filter data","func":"\nobj_keys = Object.keys(msg.payload);\nuser = msg.param.user\n\nfunction verifyClassification(classification, user){\n    owners = Object.keys(classification)\n    for (k=0; k<owners.length; k++){\n        owner = owners[k];\n        readers = classification[owner];\n        // User needs to be included in all policies\n        // in the classification to be allowed to read\n        // the data\n        if(user!=owner && !readers.includes(user)){\n            return false;\n        }\n    }\n    return true;\n}\n\ndata = []\nfor(i=0; i<obj_keys.length; i++){\n    key = obj_keys[i]\n    obj = msg.payload[key]\n    //node.warn(\"Key:\" + key)\n    for (j=0; j<obj.length; j++){\n        data_point = obj[j]\n        classification = data_point.classification\n        if(verifyClassification(classification, user)){\n            if('position' in data_point.properties){\n                return_obj = data_point.properties.position\n                return_obj.device_id = data_point.device_id\n                data.push(return_obj)\n            }\n            //data.push(data_point.properties)   \n        }\n    }\n    //node.warn(\"i=\" + i)\n}\n\nif (\"limit\" in msg.param){\n    N = parseInt(msg.param.limit)\n    data = data.slice(data.length-1-N)\n}\n\nmsg.data = data\nmsg.payload = data\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":160,"wires":[["6a918290.6bd87c","f24dd68e.f24968"]]},{"id":"13f2485f.4e9458","type":"file in","z":"a36580c0.b9cfc","name":"Load stored devices","filename":"/data/taxi_data_file","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":580,"y":160,"wires":[["a6cd8fc7.3417e"]]},{"id":"a6cd8fc7.3417e","type":"json","z":"a36580c0.b9cfc","name":"","property":"payload","action":"","pretty":false,"x":770,"y":160,"wires":[["565297f6.ed7cf8","b719e5d9.0b5d58"]]},{"id":"f24dd68e.f24968","type":"debug","z":"a36580c0.b9cfc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1140,"y":240,"wires":[]},{"id":"b99bbdda.7e021","type":"function","z":"a36580c0.b9cfc","name":"Extract params","func":"\n//msg.user = msg.payload.user\nmsg.param = msg.payload\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":360,"y":160,"wires":[["13f2485f.4e9458","c7e2a410.3b78a8"]]},{"id":"4ba8d801.b18448","type":"function","z":"a36580c0.b9cfc","name":"Mock request","func":"msg.payload = {}\nmsg.payload.user = 'CompanyA'\nmsg.payload.limit = '5'\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":280,"wires":[["b99bbdda.7e021"]]},{"id":"10d02bc6.b59df4","type":"inject","z":"a36580c0.b9cfc","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":280,"wires":[["4ba8d801.b18448"]]},{"id":"b719e5d9.0b5d58","type":"debug","z":"a36580c0.b9cfc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":900,"y":260,"wires":[]},{"id":"953feab6.22d408","type":"read-property","z":"89ad9af9.5b24b8","name":"","topic":"","thing":"55af362.e170ec8","property":"pulse","uriVariables":"{\"pulse\":\"http://192.168.1.128:9001/properties/pulse\"}","interval":5,"observe":false,"x":280,"y":260,"wires":[["99c729e1.2ea7d8"]]},{"id":"ae627947.b09838","type":"http request","z":"89ad9af9.5b24b8","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://patient-a:8888","tls":"","persist":false,"proxy":"","authType":"","x":380,"y":440,"wires":[["672f0e3d.77f1f"]]},{"id":"672f0e3d.77f1f","type":"debug","z":"89ad9af9.5b24b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":620,"y":440,"wires":[]},{"id":"bcd52eeb.73a52","type":"inject","z":"89ad9af9.5b24b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":440,"wires":[["ae627947.b09838"]]},{"id":"99c729e1.2ea7d8","type":"debug","z":"89ad9af9.5b24b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":490,"y":260,"wires":[]},{"id":"a1ed63c9.e6699","type":"mongodb in","z":"89ad9af9.5b24b8","mongodb":"2f9284ff.b82f8c","name":"","collection":"users","operation":"find","x":520,"y":660,"wires":[["e13d80d5.dc792"]]},{"id":"3f2c10b0.04d03","type":"mongodb out","z":"89ad9af9.5b24b8","mongodb":"2f9284ff.b82f8c","name":"","collection":"users","payonly":true,"upsert":true,"multi":false,"operation":"update","x":740,"y":760,"wires":[]},{"id":"82f3e18a.c9879","type":"inject","z":"89ad9af9.5b24b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"query","v":"{\"name\":\"marcus2\"}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"$set\": {\"age\":\"30\"}}","payloadType":"json","x":470,"y":760,"wires":[["3f2c10b0.04d03"]]},{"id":"8c8e15fc.dd8418","type":"inject","z":"89ad9af9.5b24b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"name\":\"marcus2\"}","payloadType":"json","x":280,"y":660,"wires":[["a1ed63c9.e6699"]]},{"id":"e13d80d5.dc792","type":"debug","z":"89ad9af9.5b24b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":800,"y":680,"wires":[]},{"id":"47bff791.5eef28","type":"http request","z":"89ad9af9.5b24b8","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"192.168.128.8:8888","tls":"","persist":false,"proxy":"","authType":"","x":390,"y":480,"wires":[["8b9b4f76.ca838"]]},{"id":"8b9b4f76.ca838","type":"debug","z":"89ad9af9.5b24b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":630,"y":480,"wires":[]},{"id":"e37a5a5e.d98eb8","type":"inject","z":"89ad9af9.5b24b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":480,"wires":[["47bff791.5eef28"]]},{"id":"1e69d150.b1335f","type":"mongodb in","z":"89ad9af9.5b24b8","mongodb":"f69609b1.cb1968","name":"","collection":"devices","operation":"find","x":550,"y":880,"wires":[["e73594fd.60ad48"]]},{"id":"78f161db.b2673","type":"inject","z":"89ad9af9.5b24b8","name":"Append pulse value","props":[{"p":"query","v":"{\"id\":\"mock:pulse:a17abf86-1eb3-460e-8b3c-1206102184b71\"}","vt":"json"},{"p":"topic","vt":"str"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"$push\": {\"properties.pulse.values\":{\"value\":4,\"time\":123}}}","payloadType":"json","x":250,"y":1040,"wires":[["f227b8f8.c874d8"]]},{"id":"e73594fd.60ad48","type":"debug","z":"89ad9af9.5b24b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":870,"y":880,"wires":[]},{"id":"37d81bf4.d9a494","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":960,"y":980,"wires":[]},{"id":"21890253.5bd7de","type":"switch","z":"8f5695d4.26e138","name":"statusCode=200","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1660,"y":1100,"wires":[["b68c4eb7.09a82","ab9f7cb5.64cce"]]},{"id":"b68c4eb7.09a82","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1870,"y":1140,"wires":[]},{"id":"c37a25ed.597728","type":"debug","z":"8f5695d4.26e138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2030,"y":1100,"wires":[]},{"id":"ab9f7cb5.64cce","type":"function","z":"8f5695d4.26e138","name":"","func":"\nmsg.query = {'device_id':msg.device_id}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1880,"y":1100,"wires":[["c37a25ed.597728"]]},{"id":"f227b8f8.c874d8","type":"mongodb out","z":"89ad9af9.5b24b8","mongodb":"f69609b1.cb1968","name":"","collection":"devices","payonly":true,"upsert":true,"multi":false,"operation":"update","x":590,"y":1040,"wires":[]},{"id":"dba7517b.4d829","type":"inject","z":"89ad9af9.5b24b8","name":"Get complete device object","props":[{"p":"query","v":"{\"id\":\"mock:pulse:a17abf86-1eb3-460e-8b3c-1206102184b71\"}","vt":"json"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":270,"y":880,"wires":[["1e69d150.b1335f"]]},{"id":"447a0da2.902204","type":"mongodb in","z":"89ad9af9.5b24b8","mongodb":"f69609b1.cb1968","name":"","collection":"properties","operation":"find","x":560,"y":940,"wires":[["fb6b8601.7f3a58"]]},{"id":"fb6b8601.7f3a58","type":"debug","z":"89ad9af9.5b24b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":870,"y":940,"wires":[]},{"id":"40056cce.ad3464","type":"inject","z":"89ad9af9.5b24b8","name":"Get properties device object","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{}","payloadType":"json","x":280,"y":940,"wires":[["447a0da2.902204"]]},{"id":"e02c351.8b9c5c8","type":"mongodb in","z":"8f5695d4.26e138","mongodb":"f69609b1.cb1968","name":"","collection":"devices","operation":"find","x":440,"y":1120,"wires":[["236747d0.8803d8","ca9691fe.f21a4"]]},{"id":"5e4760cf.ab9af","type":"inject","z":"8f5695d4.26e138","name":"Query device properties","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"projection","v":"{\"_id\":0,\"id\":1,\"classification\":1,\"properties\":1,\"base\":1}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":1120,"wires":[["e02c351.8b9c5c8"]]},{"id":"236747d0.8803d8","type":"debug","z":"8f5695d4.26e138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":680,"y":1180,"wires":[]},{"id":"ca9691fe.f21a4","type":"function","z":"8f5695d4.26e138","name":"Format properties","func":"\nproperties = []\n\ndevice_id = msg.payload[ii].id\nclassification = msg.payload.classification\nbase = msg.payload.base.replace(/\\/$/, \"\");\nfor (var prop in msg.payload.properties){\n    property = msg.payload.properties[prop]\n    property.device_id = device_id\n    property.classification = classification\n    property.name = prop\n    property.url = base + property.links[0].href\n    properties.push(property)\n}\nmsg.payload = properties;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":1120,"wires":[["bdef9cf7.e44c","b2796283.b171b"]]},{"id":"bdef9cf7.e44c","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":900,"y":1180,"wires":[]},{"id":"b834355e.dddca8","type":"function","z":"8f5695d4.26e138","name":"Prepare request","func":"\nmsg.headers=flow.get('HEADERS')\nmsg.url = msg.payload.url\n\nmsg.property = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1030,"y":1120,"wires":[["c2b3ddd9.ee004","5bf78aeb.a513e4"]]},{"id":"c2b3ddd9.ee004","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1330,"y":1200,"wires":[]},{"id":"5bf78aeb.a513e4","type":"http request","z":"8f5695d4.26e138","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1310,"y":1140,"wires":[["51853c58.8148e4","d77bdea0.386a6"]]},{"id":"51853c58.8148e4","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1490,"y":1200,"wires":[]},{"id":"431b0670.3e0288","type":"function","z":"8f5695d4.26e138","name":"Create property object","func":"\nvalue = msg.payload[msg.property.name]\n\ntime = timestamp = Date.now();\ndata = {\"value\":value, \"time\":time}\n\n\n\nmsg.payload = data\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1680,"y":1140,"wires":[["7ef20c9e.d3ea74","fc24417b.d7849","b7ea282e.c787d8"]]},{"id":"7ef20c9e.d3ea74","type":"debug","z":"8f5695d4.26e138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1770,"y":1320,"wires":[]},{"id":"fc24417b.d7849","type":"function","z":"8f5695d4.26e138","name":"Update property metadata","func":"\nmsg.query = {\"device_id\":msg.property.device_id, \"name\":msg.property.name}\nmsg.payload = {\"$set\":msg.property}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1910,"y":1180,"wires":[["ca89f047.50713","ed06b6c7.369138"]]},{"id":"b7ea282e.c787d8","type":"function","z":"8f5695d4.26e138","name":"Update property value","func":"\nmsg.query = {\"device_id\":msg.property.device_id, \"name\":msg.property.name}\n//name = msg.property.name + \".data\"\n//data = {}\n//data[\"name\"] = msg.payload\n\npayload = {\"$push\": {\"data\":msg.payload}}\n\nmsg.payload = payload;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1900,"y":1220,"wires":[["cca0bf50.ab16a","c3001bf8.886db8"]]},{"id":"ca89f047.50713","type":"debug","z":"8f5695d4.26e138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2170,"y":1160,"wires":[]},{"id":"cca0bf50.ab16a","type":"debug","z":"8f5695d4.26e138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2130,"y":1320,"wires":[]},{"id":"c3001bf8.886db8","type":"mongodb out","z":"8f5695d4.26e138","mongodb":"f69609b1.cb1968","name":"Push data","collection":"properties","payonly":false,"upsert":false,"multi":false,"operation":"update","x":2160,"y":1260,"wires":[]},{"id":"ed06b6c7.369138","type":"mongodb out","z":"8f5695d4.26e138","mongodb":"f69609b1.cb1968","name":"Update metadata","collection":"properties","payonly":false,"upsert":true,"multi":false,"operation":"update","x":2190,"y":1200,"wires":[]},{"id":"a0873417.295ca8","type":"mongodb in","z":"84e53390.36c6","mongodb":"f69609b1.cb1968","name":"","collection":"devices","operation":"find","x":290,"y":80,"wires":[["93965560.364828"]]},{"id":"93965560.364828","type":"function","z":"84e53390.36c6","name":"Format properties","func":"\nproperties = []\n\nfor(ii=0; ii<msg.payload.length; ii++) {\n    device_id = msg.payload[ii].id\n    classification = msg.payload[ii].classification\n    base = msg.payload[ii].base.replace(/\\/$/, \"\");\n    for (var prop in msg.payload[ii].properties){\n        property = msg.payload[ii].properties[prop]\n        property.device_id = device_id\n        property.classification = classification\n        property.name = prop\n        property.url = base + property.links[0].href\n        properties.push(property)\n    }\n}\nmsg.payload = properties;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":530,"y":80,"wires":[[]]},{"id":"8507f90d.5b4468","type":"subflow:84e53390.36c6","z":"8f5695d4.26e138","name":"","x":570,"y":1260,"wires":[["72a6552a.8157ac"]]},{"id":"ac45443b.aad2a8","type":"inject","z":"8f5695d4.26e138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":370,"y":1260,"wires":[["8507f90d.5b4468"]]},{"id":"72a6552a.8157ac","type":"debug","z":"8f5695d4.26e138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":780,"y":1300,"wires":[]},{"id":"d77bdea0.386a6","type":"switch","z":"8f5695d4.26e138","name":"statusCode=200","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1480,"y":1140,"wires":[["431b0670.3e0288"]]},{"id":"57e4d8fb.08ec18","type":"function","z":"1a50fa2e.f03ac6","name":"Prepare request","func":"\nif (msg.headers == undefined){\n    msg.headers = {\"Accept\": \"application/json\", 'Content-Type': 'application/json'}\n}\n\nmsg.url = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":260,"y":200,"wires":[["4d2e5844.3bb248"]]},{"id":"4d2e5844.3bb248","type":"http request","z":"1a50fa2e.f03ac6","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":200,"wires":[["11f7af50.4e17e1","539ab21e.2baa5c"]]},{"id":"11f7af50.4e17e1","type":"switch","z":"1a50fa2e.f03ac6","name":"statusCode=200","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":700,"y":140,"wires":[[]]},{"id":"539ab21e.2baa5c","type":"switch","z":"1a50fa2e.f03ac6","name":"statusCode!=200","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":710,"y":220,"wires":[[]]},{"id":"91e4894f.20f558","type":"subflow:1a50fa2e.f03ac6","z":"8f5695d4.26e138","name":"","x":480,"y":280,"wires":[["eacd0cdd.76f5d","39b8309d.66c3a"],["ae3c59dd.a0a1a8"]]},{"id":"38677424.61953c","type":"inject","z":"8f5695d4.26e138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"HOSTS","payloadType":"flow","x":140,"y":280,"wires":[["24edfc7a.fca934"]]},{"id":"24edfc7a.fca934","type":"split","z":"8f5695d4.26e138","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"url","x":300,"y":280,"wires":[["91e4894f.20f558"]]},{"id":"ae3c59dd.a0a1a8","type":"debug","z":"8f5695d4.26e138","name":"Error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":640,"y":340,"wires":[]},{"id":"eacd0cdd.76f5d","type":"change","z":"8f5695d4.26e138","name":"Update device query","rules":[{"t":"set","p":"query","pt":"msg","to":"{'id':msg.payload.id}","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"{\"$set\":msg.payload}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":240,"wires":[["7ff875d3.0fd8ec","2d25a2eb.1190ce"]]},{"id":"7ff875d3.0fd8ec","type":"debug","z":"8f5695d4.26e138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":920,"y":200,"wires":[]},{"id":"39b8309d.66c3a","type":"function","z":"8f5695d4.26e138","name":"Create property object","func":"\nproperties = []\n\ndevice_id = msg.payload.id\nclassification = msg.payload.classification\nbase = msg.payload.base.replace(/\\/$/, \"\");\nfor (var prop in msg.payload.properties){\n    property = msg.payload.properties[prop]\n    property.device_id = device_id\n    property.classification = classification\n    property.name = prop\n    property.url = base + property.links[0].href\n    properties.push(property)\n}\nmsg.payload = properties;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":730,"y":300,"wires":[["5b5e0e62.7280e"]]},{"id":"74e8ecd8.add924","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1220,"y":260,"wires":[]},{"id":"5b5e0e62.7280e","type":"split","z":"8f5695d4.26e138","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":900,"y":300,"wires":[["9f379298.01f75"]]},{"id":"9f379298.01f75","type":"change","z":"8f5695d4.26e138","name":"Update prop query","rules":[{"t":"set","p":"query","pt":"msg","to":"{'device_id':msg.payload.device_id}","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"{\"$set\":msg.payload}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":300,"wires":[["74e8ecd8.add924","8aafaf3d.75ce7"]]},{"id":"2d25a2eb.1190ce","type":"mongodb out","z":"8f5695d4.26e138","mongodb":"f69609b1.cb1968","name":"","collection":"devices","payonly":false,"upsert":true,"multi":false,"operation":"update","x":960,"y":240,"wires":[]},{"id":"8aafaf3d.75ce7","type":"mongodb out","z":"8f5695d4.26e138","mongodb":"f69609b1.cb1968","name":"Update metadata","collection":"properties","payonly":false,"upsert":true,"multi":false,"operation":"update","x":1260,"y":300,"wires":[]},{"id":"3b5793a9.7485dc","type":"mongodb in","z":"8f5695d4.26e138","mongodb":"f69609b1.cb1968","name":"","collection":"properties","operation":"find","x":380,"y":500,"wires":[["e2bfe81f.e99898","b8669dd.a55966"]]},{"id":"b30db75d.ccabb8","type":"inject","z":"8f5695d4.26e138","name":"Query device properties","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"projection","v":"{\"_id\":0,\"url\":1,\"device_id\":1,\"name\":1}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":500,"wires":[["3b5793a9.7485dc"]]},{"id":"e2bfe81f.e99898","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":570,"y":460,"wires":[]},{"id":"b8669dd.a55966","type":"split","z":"8f5695d4.26e138","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":550,"y":500,"wires":[["cd3cc10d.42663"]]},{"id":"2eb64e7f.e64a92","type":"http request","z":"988498cc.3d0758","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":180,"wires":[["f9b4bfcd.f0083","cfd02a2c.1b2b78"]]},{"id":"2391851e.77056a","type":"function","z":"988498cc.3d0758","name":"Format property object","func":"\nproperty = msg.property\n\nprop_name = property.name\nvalue = msg.payload[prop_name]\ntime = timestamp = Date.now();\ndata = {\"value\":value, \"time\":time}\n\nproperty.data = data;\n\nmsg.payload = property;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":900,"y":180,"wires":[[]]},{"id":"f9b4bfcd.f0083","type":"switch","z":"988498cc.3d0758","name":"statusCode=200","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":680,"y":180,"wires":[["2391851e.77056a"]]},{"id":"cfd02a2c.1b2b78","type":"switch","z":"988498cc.3d0758","name":"statusCode!=200","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":690,"y":240,"wires":[[]]},{"id":"9285c4dc.af9268","type":"function","z":"988498cc.3d0758","name":"Prepare request","func":"\nif (msg.headers == undefined){\n    msg.headers = {\"Accept\": \"application/json\", 'Content-Type': 'application/json'}\n}\n\nmsg.url = msg.payload.url;\nmsg.property = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":280,"y":180,"wires":[["2eb64e7f.e64a92"]]},{"id":"55de1631.5bbf28","type":"subflow:988498cc.3d0758","z":"8f5695d4.26e138","name":"","env":[],"x":910,"y":500,"wires":[["dfa43fb3.c855"],["bb8a9d46.78832"]]},{"id":"c2a81fb2.17e74","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1270,"y":440,"wires":[]},{"id":"dfa43fb3.c855","type":"change","z":"8f5695d4.26e138","name":"Set push query","rules":[{"t":"set","p":"query","pt":"msg","to":"{\"device_id\":msg.payload.device_id, \"name\":msg.payload.name}","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"{\"$push\": {\"data\":msg.payload.data}}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1120,"y":480,"wires":[["c2a81fb2.17e74","2b5e056a.07087a"]]},{"id":"2b5e056a.07087a","type":"mongodb out","z":"8f5695d4.26e138","mongodb":"f69609b1.cb1968","name":"Push data","collection":"properties","payonly":false,"upsert":false,"multi":false,"operation":"update","x":1280,"y":480,"wires":[]},{"id":"bb8a9d46.78832","type":"debug","z":"8f5695d4.26e138","name":"Error","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1090,"y":520,"wires":[]},{"id":"cd3cc10d.42663","type":"switch","z":"8f5695d4.26e138","name":"Check url exists","property":"payload.url","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":700,"y":500,"wires":[["55de1631.5bbf28","e5e594f6.669fe8"]]},{"id":"e5e594f6.669fe8","type":"debug","z":"8f5695d4.26e138","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":890,"y":460,"wires":[]},{"id":"1e32c6e8.3c13d9","type":"function","z":"e7ae0c3a.b2112","name":"","func":"\nif (msg.payload.principal==undefined){\n    msg.payload.principal = 'Public'\n}\nmsg.principal = msg.payload.principal;\n\nmsg.projection = {\"_id\":1, \"classification\":1}\n\nquery = {}\nif (msg.payload.name!=undefined){\n    query.name = msg.payload.name;\n} \n\nmsg.payload = query;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":960,"wires":[["8126136.f3390f","9b464d8e.b9cdd"]]},{"id":"e25cb20e.5f39d","type":"inject","z":"e7ae0c3a.b2112","name":"Fetch properties","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"principal\":\"Doctor\"}","payloadType":"json","x":190,"y":960,"wires":[["1e32c6e8.3c13d9"]]},{"id":"8126136.f3390f","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":630,"y":880,"wires":[]},{"id":"9b464d8e.b9cdd","type":"mongodb in","z":"e7ae0c3a.b2112","mongodb":"f69609b1.cb1968","name":"Get authorized data","collection":"properties","operation":"find","x":730,"y":960,"wires":[["b5b7885f.b6ae18"]]},{"id":"24af428d.519dbe","type":"inject","z":"e7ae0c3a.b2112","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"name\":\"pulse\"}","payloadType":"json","x":220,"y":1020,"wires":[["1e32c6e8.3c13d9"]]},{"id":"b5b7885f.b6ae18","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":920,"y":1020,"wires":[]},{"id":"74e39c9c.ccfb34","type":"mongodb in","z":"89ad9af9.5b24b8","mongodb":"f69609b1.cb1968","name":"","collection":"devices","operation":"find","x":710,"y":1220,"wires":[["6e115c23.9d6b64"]]},{"id":"6e115c23.9d6b64","type":"debug","z":"89ad9af9.5b24b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":950,"y":1220,"wires":[]},{"id":"41fc03e.d5fbffc","type":"inject","z":"89ad9af9.5b24b8","name":"Get properties device object","props":[{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":260,"y":1220,"wires":[["914fa2cb.90621"]]},{"id":"368d64b9.d10ddc","type":"comment","z":"89ad9af9.5b24b8","name":"","info":"Script query","x":190,"y":1180,"wires":[]},{"id":"914fa2cb.90621","type":"function","z":"89ad9af9.5b24b8","name":"","func":"\nprincipal = \"Doctors\"\n\nfunction replaceAll(string, search, replace) {\n  return string.split(search).join(replace);\n}\n\nfunc = function(classification) { \n    for (var owner in classification){\n        if (\"$principal\" != owner && !classification[owner].includes(\"$principal\")){\n            return false            \n        }\n    }\n    return true; \n}\n/*\nquery = { \"$where\": \n\"function() { return this.title==\\\"PatientA\\\"; }\"\n}\n//query = {\"$where\": func}\n*/\nvar rep = \"$principal\";\nvar patt = new RegExp(rep, \"g\");\n//func_string = func.toString().replace(patt, principal);\nfunc_string = replaceAll(func.toString(), \"$principal\", principal);\n//query = {\"$where\": func.toString()};\n\nquery = {\"$expr\": { \"$function\": {\n      \"body\": func_string,\n      \"args\": [ \"$classification\" ],\n      \"lang\": \"js\"\n} } }\n\n\nmsg.function = func_string;\nmsg.payload = query;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":1220,"wires":[["74e39c9c.ccfb34","2e9df26a.91d25e"]]},{"id":"7ce4d6ea.5e2fa8","type":"inject","z":"89ad9af9.5b24b8","name":"Get properties device object","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"$where\":\"function() {return (this.title==PatientA)}\"}","payloadType":"json","x":340,"y":1340,"wires":[["2e9df26a.91d25e","74e39c9c.ccfb34"]]},{"id":"2e9df26a.91d25e","type":"debug","z":"89ad9af9.5b24b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"function","targetType":"msg","statusVal":"","statusType":"auto","x":710,"y":1340,"wires":[]},{"id":"e9e17ecb.cc0b8","type":"function","z":"14204bc3.e267a4","name":"Safe classification query","func":"if (msg.principal==undefined){\n    msg.principal = 'Public'\n}\n\nfunction replaceAll(string, search, replace) {\n  return string.split(search).join(replace);\n}\n\nfunc = function(classification) { \n    for (var owner in classification){\n        if (\"$principal\" != owner && !classification[owner].includes(\"$principal\")){\n            return false            \n        }\n    }\n    return true; \n}\n\nvar rep = \"$principal\";\nvar patt = new RegExp(rep, \"g\");\n\nfunc_string = replaceAll(func.toString(), \"$principal\", msg.principal);\n\nquery = {\"$expr\": { \"$function\": {\n      \"body\": func_string,\n      \"args\": [ \"$classification\" ],\n      \"lang\": \"js\"\n} } }\n\nif (msg.query!=undefined){\n    query = { $and: [ query, msg.query ] } \n}\n\nmsg.function = func_string; //Debug\nmsg.payload = query;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":510,"y":240,"wires":[[]]},{"id":"7ed2289e.ef23f8","type":"subflow:14204bc3.e267a4","z":"e7ae0c3a.b2112","name":"","env":[],"x":540,"y":1160,"wires":[["7885a61d.834ed8","f88b8f03.ed1fa"]]},{"id":"5f77daf0.a269c4","type":"inject","z":"e7ae0c3a.b2112","name":"","props":[{"p":"payload"},{"p":"principal","v":"PatientA","vt":"str"},{"p":"query","v":"{\"title\":\"Pulse\"}","vt":"json"},{"p":"projection","v":"{\"data\":1}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":320,"y":1160,"wires":[["7ed2289e.ef23f8"]]},{"id":"d3c4ef83.ba847","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1010,"y":1160,"wires":[]},{"id":"7885a61d.834ed8","type":"mongodb in","z":"e7ae0c3a.b2112","mongodb":"f69609b1.cb1968","name":"","collection":"properties","operation":"find","x":760,"y":1160,"wires":[["d3c4ef83.ba847"]]},{"id":"f88b8f03.ed1fa","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":730,"y":1220,"wires":[]},{"id":"cb760c48.7a398","type":"http in","z":"e7ae0c3a.b2112","name":"","url":"/properties","method":"get","upload":false,"swaggerDoc":"","x":220,"y":1320,"wires":[["6de6ad4e.aaf474","cf56fa81.ce62f8"]]},{"id":"6de6ad4e.aaf474","type":"function","z":"e7ae0c3a.b2112","name":"Extract params","func":"/*\nmsg.payload = {\n    \"device_id\":\"mock:pulse:patientA\",\n    \"@type\":\"Pulse\",\n    \"principal\":\"PatientA\"\n}\n*/\nif (msg.payload.principal==undefined){\n    msg.payload.principal = 'Public';\n}\nmsg.principal = msg.payload.principal;\n\nmsg.query = {};\nif (msg.payload.device_id!=undefined){\n    msg.query['device_id']=msg.payload.device_id\n}\n\nif (msg.payload['@type']!=undefined){\n    msg.query['@type'] = msg.payload['@type'];\n}\n\nmsg.projection = {'_id':0};\nif (msg.payload.fetch!=undefined){\n    fetch = msg.payload.fetch.split(',');\n    msg.fetch = fetch;\n    for (var i=0; i<fetch.length; i++){\n        msg.projection[fetch[i]] = 1;\n    }\n}\n//msg.query = undefined;\n//msg.user = msg.payload.user\n//msg.param = msg.payload\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":1320,"wires":[["ae450367.00875","f2e58ae5.698258"]]},{"id":"dd8448f6.4bf0f8","type":"function","z":"e7ae0c3a.b2112","name":"Mock request","func":"msg.payload = {\n    \"device_id\":\"mock:pulse:patientA\",\n    \"@type\":\"PulseData\",\n    \"principal\":\"PatientA\",\n    \"fetch\": \"name,data\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":430,"y":1380,"wires":[["6de6ad4e.aaf474"]]},{"id":"b8dd4c11.c706","type":"inject","z":"e7ae0c3a.b2112","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":230,"y":1380,"wires":[["dd8448f6.4bf0f8"]]},{"id":"ae450367.00875","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":630,"y":1280,"wires":[]},{"id":"f2e58ae5.698258","type":"subflow:14204bc3.e267a4","z":"e7ae0c3a.b2112","name":"","env":[],"x":640,"y":1320,"wires":[["200d8b15.abd154","ed14d24c.a3b12"]]},{"id":"588dbba2.5ed6d4","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1050,"y":1280,"wires":[]},{"id":"200d8b15.abd154","type":"mongodb in","z":"e7ae0c3a.b2112","mongodb":"f69609b1.cb1968","name":"","collection":"properties","operation":"find","x":860,"y":1320,"wires":[["588dbba2.5ed6d4","2edb14fc.b3fe2c"]]},{"id":"ed14d24c.a3b12","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":830,"y":1280,"wires":[]},{"id":"2edb14fc.b3fe2c","type":"http response","z":"e7ae0c3a.b2112","name":"","statusCode":"","headers":{},"x":1050,"y":1320,"wires":[]},{"id":"cf56fa81.ce62f8","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":440,"y":1260,"wires":[]},{"id":"6421c273.673f2c","type":"http in","z":"e7ae0c3a.b2112","name":"","url":"/function","method":"get","upload":false,"swaggerDoc":"","x":230,"y":1500,"wires":[["24d534a7.e32ccc","81e0541a.cf9618"]]},{"id":"24d534a7.e32ccc","type":"function","z":"e7ae0c3a.b2112","name":"Extract params","func":"node.warn(msg.payload.principal)\nif (msg.payload.principal==undefined){\n    node.warn(\"Replace with public\");\n    msg.payload.principal = 'Public';\n    node.warn(msg.payload.principal);\n}\nmsg.principal = msg.payload.principal;\n\nmsg.name = msg.payload.name\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":1500,"wires":[["33bc6fac.56b49"]]},{"id":"357928eb.e68368","type":"function","z":"e7ae0c3a.b2112","name":"Mock request","func":"msg.payload = {\n    \"device_id\":\"mock:pulse:patientA\",\n    \"@type\":\"PulseData\",\n    \"principal\":\"PatientA\",\n    \"fetch\": \"name,data\",\n    \"name\":\"mean\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":450,"y":1560,"wires":[["24d534a7.e32ccc"]]},{"id":"98956b12.da6998","type":"inject","z":"e7ae0c3a.b2112","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1180,"y":1700,"wires":[["357928eb.e68368"]]},{"id":"33bc6fac.56b49","type":"switch","z":"e7ae0c3a.b2112","name":"","property":"name","propertyType":"msg","rules":[{"t":"eq","v":"mean","vt":"str"},{"t":"eq","v":"test","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":690,"y":1500,"wires":[["923aae04.9c18d"],["51f45e02.8625"],["3e0e4f62.347b8"]]},{"id":"923aae04.9c18d","type":"function","z":"e7ae0c3a.b2112","name":"Mean","func":"\n// Function specification \n// Data set\n// Final label\n\ndata_sets = [\"mock:pulse:patientA\", \"mock:pulse:patientB\"]\nmsg.property = 'data'\n\nmsg.query = {\"device_id\" : {\"$in\" : data_sets }}\nmsg.projection = {\"classification\":1}\nmsg.projection[msg.property] = 1;\n\n//debug\nmsg.payload = \"Mean function requested\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":890,"y":1460,"wires":[["28e71e26.0120b2","40b2368c.4fd498"]]},{"id":"51f45e02.8625","type":"function","z":"e7ae0c3a.b2112","name":"Test","func":"msg.payload = \"Test function requested\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":890,"y":1500,"wires":[["e2d3f9bd.4d9e28","28e71e26.0120b2"]]},{"id":"e2d3f9bd.4d9e28","type":"http response","z":"e7ae0c3a.b2112","name":"","statusCode":"","headers":{},"x":1090,"y":1560,"wires":[]},{"id":"81e0541a.cf9618","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":470,"y":1460,"wires":[]},{"id":"28e71e26.0120b2","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1090,"y":1600,"wires":[]},{"id":"3e0e4f62.347b8","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":910,"y":1660,"wires":[]},{"id":"40b2368c.4fd498","type":"change","z":"e7ae0c3a.b2112","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"query","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":1420,"wires":[["a35ca60e.dd1688","3964e103.2900be"]]},{"id":"918da109.dbb19","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1370,"y":1360,"wires":[]},{"id":"a35ca60e.dd1688","type":"mongodb in","z":"e7ae0c3a.b2112","mongodb":"f69609b1.cb1968","name":"","collection":"properties","operation":"find","x":1280,"y":1420,"wires":[["918da109.dbb19","5cdeab1d.aa40e4"]]},{"id":"3964e103.2900be","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1260,"y":1500,"wires":[]},{"id":"5cdeab1d.aa40e4","type":"function","z":"e7ae0c3a.b2112","name":"Extract and split data and classification","func":"\n\ndata = []\nclassification_array = []\n\nfor (var i=0; i<msg.payload.length; i++){\n    if(msg.payload[i][msg.property]!=undefined){\n        data.push(msg.payload[i][msg.property])\n        classification_array.push(msg.payload[i].classification);\n    }\n}\n\nfunction_input = {}\nfunction_input.payload = data\n\nmsg.classification = classification_array;\ndelete msg.payload;\n\nreturn [function_input, msg];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1570,"y":1420,"wires":[["1668c209.68ebce","3dcdc01a.722f7"],["1738d749.160b19","4d70422e.5c5c9c"]]},{"id":"1668c209.68ebce","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1630,"y":1340,"wires":[]},{"id":"1738d749.160b19","type":"debug","z":"e7ae0c3a.b2112","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1630,"y":1480,"wires":[]},{"id":"3dcdc01a.722f7","type":"function","z":"e7ae0c3a.b2112","name":"Untrusted function","func":"mean = []\n\nfor (var i=0; i<msg.payload[0].length; i++){\n    sum = 0;\n    for (var j=0; j<msg.payload.length; j++){\n            sum = sum + msg.payload[j][i].value;\n    }\n    mean.push(sum/msg.payload.length);\n}\n\nmsg.payload = mean;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1890,"y":1380,"wires":[["4d70422e.5c5c9c"]]},{"id":"d30acd9c.7a3ad","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2110,"y":1380,"wires":[]},{"id":"4d70422e.5c5c9c","type":"merge","z":"e7ae0c3a.b2112","name":"","timeout":"","x":1970,"y":1440,"wires":[["d30acd9c.7a3ad"]]},{"id":"a94dad63.eaa89","type":"function","z":"29f03fb6.bae","name":"Get policy owner query","func":"if (msg.owners==undefined){\n    msg.owners = ['Public']\n}\n\nfunction replaceAll(string, search, replace) {\n  return string.split(search).join(replace);\n}\n\nfunction arrayToString(array){\n    str = \"\";\n    for(var ii=0; ii<array.length; ii++){\n        str+=(\"\\\"\" + array[ii].toString() + \"\\\"\");\n        if(ii<array.length-1){\n            str+=\",\";\n        }\n    }\n    return \"[\" + str + \"]\";\n}\n\nfunc = function(classification) { \n    for (var owner in classification){\n        if (!$owners.includes(owner)){\n            return false            \n        }\n    }\n    return true; \n}\n\n\n\n//var rep = \"$principal\";\n//var patt = new RegExp(rep, \"g\");\n\nfunc_string = replaceAll(func.toString(), \"$owners\", arrayToString(msg.owners));\n\nquery = {\"$expr\": { \"$function\": {\n      \"body\": func_string,\n      \"args\": [ \"$classification\" ],\n      \"lang\": \"js\"\n} } }\n\nif (msg.query!=undefined){\n    query = { $and: [ query, msg.query ] } \n}\n\nmsg.function = func_string; //Debug\nmsg.payload = query;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":500,"y":260,"wires":[[]]},{"id":"83b3ea11.656ab8","type":"inject","z":"e7ae0c3a.b2112","name":"","props":[{"p":"payload"},{"p":"owners","v":"[\"PatientA\", \"PatientB\"]","vt":"jsonata"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":1960,"wires":[["3f584de2.aa5962"]]},{"id":"13358f4e.dda671","type":"subflow:29f03fb6.bae","z":"e7ae0c3a.b2112","name":"","env":[],"x":670,"y":1820,"wires":[["1806fb11.e9a515","64853a7c.7abb74"]]},{"id":"1806fb11.e9a515","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":890,"y":1880,"wires":[]},{"id":"64853a7c.7abb74","type":"mongodb in","z":"e7ae0c3a.b2112","mongodb":"f69609b1.cb1968","name":"","collection":"properties","operation":"find","x":940,"y":1820,"wires":[["efb14325.898ef"]]},{"id":"efb14325.898ef","type":"debug","z":"e7ae0c3a.b2112","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1090,"y":1880,"wires":[]},{"id":"3f584de2.aa5962","type":"function","z":"e7ae0c3a.b2112","name":"Declassification specification","func":"\nowners = [\"PatientA\", \"PatientB\"]\n\nnew_label = {\"Research\":[]}\n\nmsg.owners = owners\nmsg.new_label = new_label;\n\nquery = {\"@type\":\"PulseData2\"}\nmsg.query = query\n\nprojection = {\n        \"classification\":1, // Mandatory\n        \"@type\":1,\n        \"data\":1\n}\nmsg.projection = projection;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":1820,"wires":[["13358f4e.dda671"]]}]